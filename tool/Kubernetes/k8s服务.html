<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.21" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.82" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Kubernets - 服务","image":[""],"datePublished":"2022-10-06T00:00:00.000Z","dateModified":"2023-01-09T06:55:55.000Z","author":[{"@type":"Person","name":"悦·宝宝","url":"https://github.com/Igarashi-G"}]}</script><meta property="og:url" content="https://igarashi-g.github.io/tool/Kubernetes/k8s%E6%9C%8D%E5%8A%A1.html"><meta property="og:site_name" content="悦 ▪ 宝宝"><meta property="og:title" content="Kubernets - 服务"><meta property="og:description" content="k8s 服务、负载均衡 和 联网"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-01-09T06:55:55.000Z"><meta property="article:tag" content="k8s"><meta property="article:published_time" content="2022-10-06T00:00:00.000Z"><meta property="article:modified_time" content="2023-01-09T06:55:55.000Z"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_3654399_e6xix4avjkd.css"><title>Kubernets - 服务 | 悦 ▪ 宝宝</title><meta name="description" content="k8s 服务、负载均衡 和 联网">
    <link rel="preload" href="/assets/style-DCFqVXmA.css" as="style"><link rel="stylesheet" href="/assets/style-DCFqVXmA.css">
    <link rel="modulepreload" href="/assets/app-BFWhIhUk.js"><link rel="modulepreload" href="/assets/k8s服务.html-DicYC5rH.js"><link rel="modulepreload" href="/assets/plugin-vueexport-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/assets/index.html-BmwPtmf_.js" as="script"><link rel="prefetch" href="/assets/home.html-CiJS9Ms1.js" as="script"><link rel="prefetch" href="/assets/intro.html-DZNC6oWu.js" as="script"><link rel="prefetch" href="/assets/slides.html-Cx8h3sNo.js" as="script"><link rel="prefetch" href="/assets/index.html-e7tQ8syA.js" as="script"><link rel="prefetch" href="/assets/index.html-DMp4KjLL.js" as="script"><link rel="prefetch" href="/assets/disable.html-BiHo1_48.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-CTiwBRWO.js" as="script"><link rel="prefetch" href="/assets/markdown.html-DBnhVBwh.js" as="script"><link rel="prefetch" href="/assets/page.html-C4qvlA93.js" as="script"><link rel="prefetch" href="/assets/PS操作基础.html-Hnnw9NFP.js" as="script"><link rel="prefetch" href="/assets/index.html-BFDyGk1C.js" as="script"><link rel="prefetch" href="/assets/SAI操作基础.html-D0pHjdP2.js" as="script"><link rel="prefetch" href="/assets/index.html-DgDBN-zR.js" as="script"><link rel="prefetch" href="/assets/index.html-DPWvAyE1.js" as="script"><link rel="prefetch" href="/assets/asyncio_recipes.html-CA6RkQPD.js" as="script"><link rel="prefetch" href="/assets/devops_in_python.html-ToD9NUcl.js" as="script"><link rel="prefetch" href="/assets/fluent_python.html-Ck-ChS8V.js" as="script"><link rel="prefetch" href="/assets/index.html-BFfTEgjZ.js" as="script"><link rel="prefetch" href="/assets/python_cookbook.html-CM5OPl3D.js" as="script"><link rel="prefetch" href="/assets/python源码剖析.html-Db_WWukm.js" as="script"><link rel="prefetch" href="/assets/use_asyncio.html-DC4pUzaX.js" as="script"><link rel="prefetch" href="/assets/index.html-1JgW5Ciy.js" as="script"><link rel="prefetch" href="/assets/亚动机与人格.html-Bwn90XkF.js" as="script"><link rel="prefetch" href="/assets/人的潜能和价值.html-n4b9ggWb.js" as="script"><link rel="prefetch" href="/assets/好人是如何变成恶魔的.html-BTzpQUzw.js" as="script"><link rel="prefetch" href="/assets/影响力.html-v-3vJG83.js" as="script"><link rel="prefetch" href="/assets/性心理学.html-8NJldCzU.js" as="script"><link rel="prefetch" href="/assets/洗脑心理学.html-BNyuCw56.js" as="script"><link rel="prefetch" href="/assets/进化心理学.html-D4dvmxcj.js" as="script"><link rel="prefetch" href="/assets/CODE.html-CNbRK7Kb.js" as="script"><link rel="prefetch" href="/assets/index.html-DnwOExSD.js" as="script"><link rel="prefetch" href="/assets/成为技术领导者.html-CzVOwa8J.js" as="script"><link rel="prefetch" href="/assets/鸟哥的Linux私房菜.html-DtecxLFr.js" as="script"><link rel="prefetch" href="/assets/鸟哥的Linux私房菜服务器架设篇.html-DNU3gZiD.js" as="script"><link rel="prefetch" href="/assets/黑客与画家.html-BeLNE_yS.js" as="script"><link rel="prefetch" href="/assets/index.html-DL8xRTcx.js" as="script"><link rel="prefetch" href="/assets/中国人的性格.html-C9CJwYIX.js" as="script"><link rel="prefetch" href="/assets/乌合之众.html-DbdQqPAI.js" as="script"><link rel="prefetch" href="/assets/娱乐至死.html-CamUEFhg.js" as="script"><link rel="prefetch" href="/assets/index.html-BEGtP2A1.js" as="script"><link rel="prefetch" href="/assets/清醒思考的艺术.html-D76SmMd1.js" as="script"><link rel="prefetch" href="/assets/index.html-Bd2OeJ5E.js" as="script"><link rel="prefetch" href="/assets/博弈论与经济行为.html-D_e-oFvE.js" as="script"><link rel="prefetch" href="/assets/就业_利息和货币通论.html-B-dEdJ8z.js" as="script"><link rel="prefetch" href="/assets/聪明的投资者.html-sbEBQ_Gj.js" as="script"><link rel="prefetch" href="/assets/货币金融学.html-DVHEfn4D.js" as="script"><link rel="prefetch" href="/assets/非理性繁荣.html-BIO94_ED.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-CScb30qg.js" as="script"><link rel="prefetch" href="/assets/Mysql调优.html-KrxVCkqH.js" as="script"><link rel="prefetch" href="/assets/Mysql进阶.html-D9PvkLgY.js" as="script"><link rel="prefetch" href="/assets/Mysql高阶.html-CxjZiwmJ.js" as="script"><link rel="prefetch" href="/assets/Navicat.html-B0XgdLp_.js" as="script"><link rel="prefetch" href="/assets/SQLAlchemy.html-CLxwaVN8.js" as="script"><link rel="prefetch" href="/assets/PostgreSQL.html-D_K3yJMx.js" as="script"><link rel="prefetch" href="/assets/redis.html-CURqUjUe.js" as="script"><link rel="prefetch" href="/assets/性能分析.html-udahOd5S.js" as="script"><link rel="prefetch" href="/assets/aioetcd3.html-CF1oET4Y.js" as="script"><link rel="prefetch" href="/assets/etcd.html-HttfNcLG.js" as="script"><link rel="prefetch" href="/assets/进阶.html-D9N3nRKd.js" as="script"><link rel="prefetch" href="/assets/go工具速用.html-DEE9_T0B.js" as="script"><link rel="prefetch" href="/assets/go语言速记.html-Dbampsee.js" as="script"><link rel="prefetch" href="/assets/数组.html-Aey-6zE6.js" as="script"><link rel="prefetch" href="/assets/栈与队列.html-YZNCDAoG.js" as="script"><link rel="prefetch" href="/assets/树.html-Ci77I6PW.js" as="script"><link rel="prefetch" href="/assets/概述.html-BFu6Pm9g.js" as="script"><link rel="prefetch" href="/assets/线性表.html-D2cawnCW.js" as="script"><link rel="prefetch" href="/assets/docker容器.html-BrM2gWXu.js" as="script"><link rel="prefetch" href="/assets/使用基础.html-BbnpPuug.js" as="script"><link rel="prefetch" href="/assets/命令.html-DmVS8kSE.js" as="script"><link rel="prefetch" href="/assets/网络.html-B3pCSh7_.js" as="script"><link rel="prefetch" href="/assets/CICD.html-CSP6A7JI.js" as="script"><link rel="prefetch" href="/assets/GIt提交规则.html-BbkuFxfA.js" as="script"><link rel="prefetch" href="/assets/Git.html-CP6v5g8F.js" as="script"><link rel="prefetch" href="/assets/安装GitLab.html-C6FyPn43.js" as="script"><link rel="prefetch" href="/assets/Helm安装使用.html-DqpBmcwC.js" as="script"><link rel="prefetch" href="/assets/k8s存储.html-b0qLAHoR.js" as="script"><link rel="prefetch" href="/assets/k8s安装.html-CVyeEsOS.js" as="script"><link rel="prefetch" href="/assets/k8s工作负载.html-CPXFQBIL.js" as="script"><link rel="prefetch" href="/assets/k8s资源Pod.html-BVBtmDOF.js" as="script"><link rel="prefetch" href="/assets/k8s进阶.html-IB5mctFv.js" as="script"><link rel="prefetch" href="/assets/Nginx基础.html-CnLyzRQN.js" as="script"><link rel="prefetch" href="/assets/应用部署.html-s3orpM93.js" as="script"><link rel="prefetch" href="/assets/Fiddler抓包工具.html-7d3I7Ah9.js" as="script"><link rel="prefetch" href="/assets/Postman.html-C_Q6oFel.js" as="script"><link rel="prefetch" href="/assets/Screen.html-4KKu8ZTl.js" as="script"><link rel="prefetch" href="/assets/rdesktop.html-Uzxi6CNT.js" as="script"><link rel="prefetch" href="/assets/tmux.html-Cqnb26u2.js" as="script"><link rel="prefetch" href="/assets/网络代理.html--UOrgrSA.js" as="script"><link rel="prefetch" href="/assets/基本使用.html-DEnRRz2z.js" as="script"><link rel="prefetch" href="/assets/安装.html-J8yXBWul.js" as="script"><link rel="prefetch" href="/assets/APScheduler.html-B7jpX5Oh.js" as="script"><link rel="prefetch" href="/assets/Celery.html-RdSlIDYL.js" as="script"><link rel="prefetch" href="/assets/Celery使用基础.html-C8Y9vJrv.js" as="script"><link rel="prefetch" href="/assets/异步任务概述.html-D6CcNrWF.js" as="script"><link rel="prefetch" href="/assets/RabbitMQ.html-BRfOh7jk.js" as="script"><link rel="prefetch" href="/assets/kafka.html-CPSh5CnL.js" as="script"><link rel="prefetch" href="/assets/kombu.html-B3YMAyJb.js" as="script"><link rel="prefetch" href="/assets/pika.html-C5NzGx_2.js" as="script"><link rel="prefetch" href="/assets/RPC.html-Q1CHswf3.js" as="script"><link rel="prefetch" href="/assets/gRPC.html-BOJW2fLJ.js" as="script"><link rel="prefetch" href="/assets/asyncio Recipes.html-C6hG0OkF.js" as="script"><link rel="prefetch" href="/assets/asyncio基础.html-CODnbQ5c.js" as="script"><link rel="prefetch" href="/assets/asyncio进阶.html-DCk6cw7U.js" as="script"><link rel="prefetch" href="/assets/事件循环.html-CeESs0Nm.js" as="script"><link rel="prefetch" href="/assets/底层实现.html-D_F2sYtv.js" as="script"><link rel="prefetch" href="/assets/异步回溯.html-CXLlnMlw.js" as="script"><link rel="prefetch" href="/assets/Python项目打包.html-BrTPPa3Z.js" as="script"><link rel="prefetch" href="/assets/pip.html-CbYUu7VG.js" as="script"><link rel="prefetch" href="/assets/字符编码.html-CwXZV3iV.js" as="script"><link rel="prefetch" href="/assets/数据类型.html-JeyjEUh4.js" as="script"><link rel="prefetch" href="/assets/文件基础.html-D5RkDgPf.js" as="script"><link rel="prefetch" href="/assets/流程控制.html-DxoMSW1b.js" as="script"><link rel="prefetch" href="/assets/环境安装.html-_8XXdYO7.js" as="script"><link rel="prefetch" href="/assets/Linux文件锁.html-DTJVW4ke.js" as="script"><link rel="prefetch" href="/assets/协程.html-BlSuWy51.js" as="script"><link rel="prefetch" href="/assets/同步队列.html-BNN8w8Yv.js" as="script"><link rel="prefetch" href="/assets/多线程编程.html-BjMDahhF.js" as="script"><link rel="prefetch" href="/assets/多进程编程.html-CNxvZ0WA.js" as="script"><link rel="prefetch" href="/assets/线程.html-BSVCTTfu.js" as="script"><link rel="prefetch" href="/assets/线程进程辅助机制.html-BIccM__q.js" as="script"><link rel="prefetch" href="/assets/进程.html-Dy3u-GFm.js" as="script"><link rel="prefetch" href="/assets/高性能编程.html-B6Z7GaaM.js" as="script"><link rel="prefetch" href="/assets/标准库链接.html-BuKv-v2N.js" as="script"><link rel="prefetch" href="/assets/Cpython对象.html-CxhTR5fq.js" as="script"><link rel="prefetch" href="/assets/垃圾回收.html-BHp_1Tns.js" as="script"><link rel="prefetch" href="/assets/序列进阶.html-N2JpeYHf.js" as="script"><link rel="prefetch" href="/assets/映射进阶.html-D8j7j3sM.js" as="script"><link rel="prefetch" href="/assets/设计模式.html-CE0VV8CF.js" as="script"><link rel="prefetch" href="/assets/Socket.html-CVofpq0l.js" as="script"><link rel="prefetch" href="/assets/Websocket.html-z_OSsgBE.js" as="script"><link rel="prefetch" href="/assets/事件模型.html-daC0ro-b.js" as="script"><link rel="prefetch" href="/assets/回调.html-D7y4Y4xd.js" as="script"><link rel="prefetch" href="/assets/信号量.html-DaGLgwFk.js" as="script"><link rel="prefetch" href="/assets/函数.html-2vvXj3mi.js" as="script"><link rel="prefetch" href="/assets/变量机制.html-kLj_uk_U.js" as="script"><link rel="prefetch" href="/assets/模块和包.html-Db-L-1W7.js" as="script"><link rel="prefetch" href="/assets/生成器.html-D-PZ7V4Z.js" as="script"><link rel="prefetch" href="/assets/装饰器.html-Cld7uD8m.js" as="script"><link rel="prefetch" href="/assets/迭代器.html-DfL0Jiyu.js" as="script"><link rel="prefetch" href="/assets/错误和异常.html-DAe21JhZ.js" as="script"><link rel="prefetch" href="/assets/面向对象.html-D70ZysYj.js" as="script"><link rel="prefetch" href="/assets/DNS服务.html-DPOJNtzj.js" as="script"><link rel="prefetch" href="/assets/bind.html-CnPICcCI.js" as="script"><link rel="prefetch" href="/assets/脚本说明.html-DMogZq37.js" as="script"><link rel="prefetch" href="/assets/AD域.html-DXyXEEzI.js" as="script"><link rel="prefetch" href="/assets/LDAP.html-C9yNBmvh.js" as="script"><link rel="prefetch" href="/assets/Python对接AD域.html-DxDWjsDh.js" as="script"><link rel="prefetch" href="/assets/NFS服务.html-ib2o3Zqa.js" as="script"><link rel="prefetch" href="/assets/NTP服务.html-B-u1S177.js" as="script"><link rel="prefetch" href="/assets/SNMP服务.html-CEIFw1lA.js" as="script"><link rel="prefetch" href="/assets/SNMP设计文档.html-B9Oid_5W.js" as="script"><link rel="prefetch" href="/assets/Samba服务.html-B7_0aXze.js" as="script"><link rel="prefetch" href="/assets/rsync.html-BqtN4e-U.js" as="script"><link rel="prefetch" href="/assets/iso构建以及发布.html-BjfSK3XO.js" as="script"><link rel="prefetch" href="/assets/ufscli工具.html-BAH9HGVG.js" as="script"><link rel="prefetch" href="/assets/ufs核心组件.html-BUDObEq0.js" as="script"><link rel="prefetch" href="/assets/ufs管理平台.html-WQQNj-S1.js" as="script"><link rel="prefetch" href="/assets/uus虚拟机排错.html-B_7cTgxN.js" as="script"><link rel="prefetch" href="/assets/CentOS的安装.html-Dz9i05Iv.js" as="script"><link rel="prefetch" href="/assets/RPM包管理.html-DvI7yj-X.js" as="script"><link rel="prefetch" href="/assets/账号管理与ACL权限.html-D5kxDU3z.js" as="script"><link rel="prefetch" href="/assets/Linux是什么与如何学习.html-iFZi3NRy.js" as="script"><link rel="prefetch" href="/assets/主机规划与磁盘分区.html-DMRk0-H_.js" as="script"><link rel="prefetch" href="/assets/计算机概论.html-CBIlAJXu.js" as="script"><link rel="prefetch" href="/assets/Linux磁盘与文件系统管理.html-CptnZlnq.js" as="script"><link rel="prefetch" href="/assets/文件与文件系统压缩.html-Fi1xXw1j.js" as="script"><link rel="prefetch" href="/assets/文件权限与目录配置.html-Dm6PesLz.js" as="script"><link rel="prefetch" href="/assets/认识系统服务.html-0z_WDRcW.js" as="script"><link rel="prefetch" href="/assets/shell.html-CkV7bVsQ.js" as="script"><link rel="prefetch" href="/assets/vim 快捷键.html-sVMOsC5L.js" as="script"><link rel="prefetch" href="/assets/备忘命令.html-C_AqzxYE.js" as="script"><link rel="prefetch" href="/assets/故障快查.html-B03aHWOa.js" as="script"><link rel="prefetch" href="/assets/操作系统.html-DMrKH2mh.js" as="script"><link rel="prefetch" href="/assets/CURL.html-Dw3VIy4m.js" as="script"><link rel="prefetch" href="/assets/P2P.html-Cp2hI8U3.js" as="script"><link rel="prefetch" href="/assets/命令.html-DYXTMCMN.js" as="script"><link rel="prefetch" href="/assets/网络基础.html-D_gVbYVm.js" as="script"><link rel="prefetch" href="/assets/Ubuntu系统.html-CvMYMhMv.js" as="script"><link rel="prefetch" href="/assets/CPU.html-CXiPnlxn.js" as="script"><link rel="prefetch" href="/assets/主板.html-CWbYkSqY.js" as="script"><link rel="prefetch" href="/assets/内存.html-CwRaPJG7.js" as="script"><link rel="prefetch" href="/assets/存储.html-DNalI-l8.js" as="script"><link rel="prefetch" href="/assets/扩展卡与接口.html-C6WhZTRe.js" as="script"><link rel="prefetch" href="/assets/显卡.html-D089B2cw.js" as="script"><link rel="prefetch" href="/assets/PVE.html-C-tV2l6M.js" as="script"><link rel="prefetch" href="/assets/添加磁盘.html-BeFtwKOP.js" as="script"><link rel="prefetch" href="/assets/网络配置.html-BP2jrbI8.js" as="script"><link rel="prefetch" href="/assets/Django基础.html-COzOLtgP.js" as="script"><link rel="prefetch" href="/assets/Django概述.html-eD2iGC2Y.js" as="script"><link rel="prefetch" href="/assets/FastAPI基础.html-Boz7KPgd.js" as="script"><link rel="prefetch" href="/assets/FastAPI基础二.html-Fnk3l4s2.js" as="script"><link rel="prefetch" href="/assets/tornado.html-D4fnqSij.js" as="script"><link rel="prefetch" href="/assets/WEB框架本质.html-D2r-nk2B.js" as="script"><link rel="prefetch" href="/assets/状态管理.html-2FyuXvqs.js" as="script"><link rel="prefetch" href="/assets/404.html-C_GohGou.js" as="script"><link rel="prefetch" href="/assets/index.html-Bo_ouIf6.js" as="script"><link rel="prefetch" href="/assets/index.html-C6q0sBMJ.js" as="script"><link rel="prefetch" href="/assets/index.html-BVJnFIIS.js" as="script"><link rel="prefetch" href="/assets/index.html-BFEEWkTe.js" as="script"><link rel="prefetch" href="/assets/index.html--bCL2UXL.js" as="script"><link rel="prefetch" href="/assets/index.html-D9fbNOtQ.js" as="script"><link rel="prefetch" href="/assets/index.html-BIkI4N1X.js" as="script"><link rel="prefetch" href="/assets/index.html-8YhL-O-a.js" as="script"><link rel="prefetch" href="/assets/index.html-C0xYBPRs.js" as="script"><link rel="prefetch" href="/assets/index.html-Dpzcv9q1.js" as="script"><link rel="prefetch" href="/assets/index.html-WVmec6vN.js" as="script"><link rel="prefetch" href="/assets/index.html-B08edxYb.js" as="script"><link rel="prefetch" href="/assets/index.html-XfdZo5Hu.js" as="script"><link rel="prefetch" href="/assets/index.html-9Zy5boGH.js" as="script"><link rel="prefetch" href="/assets/index.html-DebnCup6.js" as="script"><link rel="prefetch" href="/assets/index.html-CXZjUyVW.js" as="script"><link rel="prefetch" href="/assets/index.html-BK5JcglY.js" as="script"><link rel="prefetch" href="/assets/index.html-DY9F1W4U.js" as="script"><link rel="prefetch" href="/assets/index.html-DBWL9-MG.js" as="script"><link rel="prefetch" href="/assets/index.html-B2k-JixG.js" as="script"><link rel="prefetch" href="/assets/index.html-mN2jtnsF.js" as="script"><link rel="prefetch" href="/assets/index.html-DOGyYZ89.js" as="script"><link rel="prefetch" href="/assets/index.html-C0uRlQN2.js" as="script"><link rel="prefetch" href="/assets/index.html-C27_P9I5.js" as="script"><link rel="prefetch" href="/assets/index.html-DMj3kThr.js" as="script"><link rel="prefetch" href="/assets/index.html-OwHV6npk.js" as="script"><link rel="prefetch" href="/assets/index.html-BYRAnqOE.js" as="script"><link rel="prefetch" href="/assets/index.html-DQ5hw4OS.js" as="script"><link rel="prefetch" href="/assets/index.html-zxdUSrlc.js" as="script"><link rel="prefetch" href="/assets/index.html-DfSJXsLe.js" as="script"><link rel="prefetch" href="/assets/index.html-CBPcW4_J.js" as="script"><link rel="prefetch" href="/assets/index.html-JXOQzNIi.js" as="script"><link rel="prefetch" href="/assets/index.html-4TA_k_vt.js" as="script"><link rel="prefetch" href="/assets/index.html-DhjJCozj.js" as="script"><link rel="prefetch" href="/assets/index.html-C9NT1Crj.js" as="script"><link rel="prefetch" href="/assets/index.html-DqX8SaH-.js" as="script"><link rel="prefetch" href="/assets/index.html-AtNafjyH.js" as="script"><link rel="prefetch" href="/assets/index.html-LKM-jLPb.js" as="script"><link rel="prefetch" href="/assets/index.html-Cwf1_US4.js" as="script"><link rel="prefetch" href="/assets/index.html-CkC3vtX-.js" as="script"><link rel="prefetch" href="/assets/index.html-CJ3a1U0s.js" as="script"><link rel="prefetch" href="/assets/index.html-Bw1iy84M.js" as="script"><link rel="prefetch" href="/assets/index.html-BAoz3UN5.js" as="script"><link rel="prefetch" href="/assets/index.html-QSX4D3eK.js" as="script"><link rel="prefetch" href="/assets/index.html-DrHdb_RC.js" as="script"><link rel="prefetch" href="/assets/index.html-dXZ6su36.js" as="script"><link rel="prefetch" href="/assets/index.html-jk4BYFAE.js" as="script"><link rel="prefetch" href="/assets/index.html-B2YkFjdn.js" as="script"><link rel="prefetch" href="/assets/index.html-Cwm1dXwc.js" as="script"><link rel="prefetch" href="/assets/index.html-CywvDvbK.js" as="script"><link rel="prefetch" href="/assets/index.html-50E0zLWZ.js" as="script"><link rel="prefetch" href="/assets/index.html-BWuIGKSa.js" as="script"><link rel="prefetch" href="/assets/index.html-C6hRuQXf.js" as="script"><link rel="prefetch" href="/assets/index.html-Ct4vatx9.js" as="script"><link rel="prefetch" href="/assets/index.html-KugmZZ-4.js" as="script"><link rel="prefetch" href="/assets/index.html-BcFwFq_J.js" as="script"><link rel="prefetch" href="/assets/index.html-k4x7aSi2.js" as="script"><link rel="prefetch" href="/assets/index.html-DndFhckY.js" as="script"><link rel="prefetch" href="/assets/index.html-zGRxWl09.js" as="script"><link rel="prefetch" href="/assets/index.html-0OGCe7xF.js" as="script"><link rel="prefetch" href="/assets/index.html-msRoFKhL.js" as="script"><link rel="prefetch" href="/assets/index.html-DvYQuVJw.js" as="script"><link rel="prefetch" href="/assets/index.html-CbQrBlVk.js" as="script"><link rel="prefetch" href="/assets/index.html-1h0h7Foi.js" as="script"><link rel="prefetch" href="/assets/index.html-D4ASS3mJ.js" as="script"><link rel="prefetch" href="/assets/index.html-D4d9J2fk.js" as="script"><link rel="prefetch" href="/assets/index.html-CfLJRc-G.js" as="script"><link rel="prefetch" href="/assets/index.html-kB8nGwWY.js" as="script"><link rel="prefetch" href="/assets/index.html-CfLJRc-G.js" as="script"><link rel="prefetch" href="/assets/index.html-BJauSwbO.js" as="script"><link rel="prefetch" href="/assets/index.html-mC3u3DkZ.js" as="script"><link rel="prefetch" href="/assets/index.html-BEJz4PvV.js" as="script"><link rel="prefetch" href="/assets/index.html-gINi0WmD.js" as="script"><link rel="prefetch" href="/assets/index.html-2QXRVASr.js" as="script"><link rel="prefetch" href="/assets/index.html-F0t8gThT.js" as="script"><link rel="prefetch" href="/assets/index.html-CH-9l0BY.js" as="script"><link rel="prefetch" href="/assets/index.html-DMulnjWz.js" as="script"><link rel="prefetch" href="/assets/index.html-BNfY3iEE.js" as="script"><link rel="prefetch" href="/assets/index.html-DaROIb6Z.js" as="script"><link rel="prefetch" href="/assets/index.html-DFCp9nGU.js" as="script"><link rel="prefetch" href="/assets/index.html-a8t652nk.js" as="script"><link rel="prefetch" href="/assets/index.html-BzkrU96k.js" as="script"><link rel="prefetch" href="/assets/index.html-CFzScHtr.js" as="script"><link rel="prefetch" href="/assets/index.html-BAc2-Uxx.js" as="script"><link rel="prefetch" href="/assets/index.html-C9Gj04Tn.js" as="script"><link rel="prefetch" href="/assets/index.html-DMnvr1Pe.js" as="script"><link rel="prefetch" href="/assets/index.html-BDLsHB-g.js" as="script"><link rel="prefetch" href="/assets/index.html-bR6Z_njI.js" as="script"><link rel="prefetch" href="/assets/index.html-DQ46NFGD.js" as="script"><link rel="prefetch" href="/assets/index.html-_jF8ilF1.js" as="script"><link rel="prefetch" href="/assets/index.html-BZQqjFNP.js" as="script"><link rel="prefetch" href="/assets/index.html-CnhOrdyO.js" as="script"><link rel="prefetch" href="/assets/index.html-Bpe-diDW.js" as="script"><link rel="prefetch" href="/assets/index.html-CcK7b76F.js" as="script"><link rel="prefetch" href="/assets/index.html-m7LRmz91.js" as="script"><link rel="prefetch" href="/assets/index.html-C_kIv0KU.js" as="script"><link rel="prefetch" href="/assets/index.html-Dvslf65e.js" as="script"><link rel="prefetch" href="/assets/index.html-DfBJgg3o.js" as="script"><link rel="prefetch" href="/assets/index.html-CnBKCWFL.js" as="script"><link rel="prefetch" href="/assets/index.html-D7NgI3Wc.js" as="script"><link rel="prefetch" href="/assets/index.html-B_uYRI3s.js" as="script"><link rel="prefetch" href="/assets/index.html-D8rWHeVo.js" as="script"><link rel="prefetch" href="/assets/index.html-B21PIvde.js" as="script"><link rel="prefetch" href="/assets/index.html-B0lWLG2A.js" as="script"><link rel="prefetch" href="/assets/index.html-D47TWyAF.js" as="script"><link rel="prefetch" href="/assets/index.html-DUceuGb3.js" as="script"><link rel="prefetch" href="/assets/index.html-2CIPXhyM.js" as="script"><link rel="prefetch" href="/assets/index.html-rs2uIvDF.js" as="script"><link rel="prefetch" href="/assets/index.html-BTxXqn2V.js" as="script"><link rel="prefetch" href="/assets/index.html-CBANSrqy.js" as="script"><link rel="prefetch" href="/assets/index.html-2CIPXhyM.js" as="script"><link rel="prefetch" href="/assets/index.html-f0i2UYj8.js" as="script"><link rel="prefetch" href="/assets/index.html-CVb4wQYc.js" as="script"><link rel="prefetch" href="/assets/index.html-f-awGB2v.js" as="script"><link rel="prefetch" href="/assets/index.html-BVImBltl.js" as="script"><link rel="prefetch" href="/assets/index.html-DPVDOwLC.js" as="script"><link rel="prefetch" href="/assets/index.html-IMO6BICp.js" as="script"><link rel="prefetch" href="/assets/index.html-BFp0gS_r.js" as="script"><link rel="prefetch" href="/assets/index.html-4IKPG-x-.js" as="script"><link rel="prefetch" href="/assets/index.html-D3CpRPL4.js" as="script"><link rel="prefetch" href="/assets/index.html-DC-BwgYA.js" as="script"><link rel="prefetch" href="/assets/index.html-BIIxRCa8.js" as="script"><link rel="prefetch" href="/assets/index.html-Et6TMLBz.js" as="script"><link rel="prefetch" href="/assets/index.html-BkFZvRKv.js" as="script"><link rel="prefetch" href="/assets/index.html-D7YoN4G4.js" as="script"><link rel="prefetch" href="/assets/index.html-CyRnilC1.js" as="script"><link rel="prefetch" href="/assets/index.html-a-nQock1.js" as="script"><link rel="prefetch" href="/assets/index.html-BkFZvRKv.js" as="script"><link rel="prefetch" href="/assets/index.html-C8nU2OyX.js" as="script"><link rel="prefetch" href="/assets/index.html-Di_sHZZ9.js" as="script"><link rel="prefetch" href="/assets/index.html-Cskh60as.js" as="script"><link rel="prefetch" href="/assets/index.html-DQBdilmy.js" as="script"><link rel="prefetch" href="/assets/index.html-NMivtXpY.js" as="script"><link rel="prefetch" href="/assets/index.html-CZ7F2OLU.js" as="script"><link rel="prefetch" href="/assets/index.html-B9F6A-Xx.js" as="script"><link rel="prefetch" href="/assets/index.html-wyRi4HHt.js" as="script"><link rel="prefetch" href="/assets/index.html-CPrLfczv.js" as="script"><link rel="prefetch" href="/assets/index.html-DCZJtnps.js" as="script"><link rel="prefetch" href="/assets/index.html-B1Okyl98.js" as="script"><link rel="prefetch" href="/assets/index.html-DeRMETns.js" as="script"><link rel="prefetch" href="/assets/index.html-Mj-q6TG-.js" as="script"><link rel="prefetch" href="/assets/index.html-fcG4Ozpd.js" as="script"><link rel="prefetch" href="/assets/index.html-B6p2guA-.js" as="script"><link rel="prefetch" href="/assets/index.html-BBvE_QB8.js" as="script"><link rel="prefetch" href="/assets/index.html-IF2L1ffG.js" as="script"><link rel="prefetch" href="/assets/index.html-CnxmpEgZ.js" as="script"><link rel="prefetch" href="/assets/index.html-DiS-WcGY.js" as="script"><link rel="prefetch" href="/assets/index.html-B6ET51xg.js" as="script"><link rel="prefetch" href="/assets/index.html-XOcAWzmX.js" as="script"><link rel="prefetch" href="/assets/index.html-DvF9GNT4.js" as="script"><link rel="prefetch" href="/assets/index.html-DpM8JpZZ.js" as="script"><link rel="prefetch" href="/assets/index.html-xx_TigWr.js" as="script"><link rel="prefetch" href="/assets/index.html-C8BYmGBC.js" as="script"><link rel="prefetch" href="/assets/index.html-Cc69bV91.js" as="script"><link rel="prefetch" href="/assets/index.html-Di0cFJp4.js" as="script"><link rel="prefetch" href="/assets/index.html-DkKt9X7D.js" as="script"><link rel="prefetch" href="/assets/index.html-kwCDGehg.js" as="script"><link rel="prefetch" href="/assets/index.html-DBnyTRmE.js" as="script"><link rel="prefetch" href="/assets/index.html-CyLIG-wI.js" as="script"><link rel="prefetch" href="/assets/index.html-DkIb6yTT.js" as="script"><link rel="prefetch" href="/assets/index.html-CP7M_aGY.js" as="script"><link rel="prefetch" href="/assets/index.html-0MYZRljG.js" as="script"><link rel="prefetch" href="/assets/index.html-Duxx4BKi.js" as="script"><link rel="prefetch" href="/assets/index.html-CKClHdaK.js" as="script"><link rel="prefetch" href="/assets/index.html-N6BvhB2l.js" as="script"><link rel="prefetch" href="/assets/index.html-C8-IstAK.js" as="script"><link rel="prefetch" href="/assets/index.html-i9sd72dO.js" as="script"><link rel="prefetch" href="/assets/index.html-DzZwV6s1.js" as="script"><link rel="prefetch" href="/assets/index.html-C-lLZrh8.js" as="script"><link rel="prefetch" href="/assets/index.html-FloYdTiF.js" as="script"><link rel="prefetch" href="/assets/index.html-B51U3KzB.js" as="script"><link rel="prefetch" href="/assets/index.html-Bl90hhor.js" as="script"><link rel="prefetch" href="/assets/index.html-CC44uZFy.js" as="script"><link rel="prefetch" href="/assets/index.html-TrbQGD_7.js" as="script"><link rel="prefetch" href="/assets/index.html-C1JOr1yt.js" as="script"><link rel="prefetch" href="/assets/index.html-Cs3EJDCq.js" as="script"><link rel="prefetch" href="/assets/index.html-DLpfyrzv.js" as="script"><link rel="prefetch" href="/assets/index.html-DZ1bcEEh.js" as="script"><link rel="prefetch" href="/assets/index.html-BDg0m2OZ.js" as="script"><link rel="prefetch" href="/assets/index.html-Dij1d3tk.js" as="script"><link rel="prefetch" href="/assets/index.html-WpEXxee1.js" as="script"><link rel="prefetch" href="/assets/index.html-BsbEUffA.js" as="script"><link rel="prefetch" href="/assets/index.html-DQNsxjXu.js" as="script"><link rel="prefetch" href="/assets/index.html-DSMq4TBe.js" as="script"><link rel="prefetch" href="/assets/index.html-D9RJQRLh.js" as="script"><link rel="prefetch" href="/assets/index.html-StiFSEem.js" as="script"><link rel="prefetch" href="/assets/index.html-DeGNHpIz.js" as="script"><link rel="prefetch" href="/assets/index.html-XvY5wZC_.js" as="script"><link rel="prefetch" href="/assets/index.html-D70l3QSx.js" as="script"><link rel="prefetch" href="/assets/index.html-1hfpKXPh.js" as="script"><link rel="prefetch" href="/assets/index.html-CVuNFVlG.js" as="script"><link rel="prefetch" href="/assets/index.html-DswMnk_v.js" as="script"><link rel="prefetch" href="/assets/index.html-D9BC3i8p.js" as="script"><link rel="prefetch" href="/assets/index.html-_xPZRUXa.js" as="script"><link rel="prefetch" href="/assets/index.html-qcDFDyM3.js" as="script"><link rel="prefetch" href="/assets/index.html-DR_mqwQI.js" as="script"><link rel="prefetch" href="/assets/index.html-C9oha2iY.js" as="script"><link rel="prefetch" href="/assets/index.html-Cqc6S9cp.js" as="script"><link rel="prefetch" href="/assets/index.html-CbtZIoW5.js" as="script"><link rel="prefetch" href="/assets/index.html-Cl7tw7h0.js" as="script"><link rel="prefetch" href="/assets/index.html-C9oha2iY.js" as="script"><link rel="prefetch" href="/assets/index.html-BpfkmxGa.js" as="script"><link rel="prefetch" href="/assets/index.html-BFfa3tKT.js" as="script"><link rel="prefetch" href="/assets/index.html-CGbKTj3z.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-DXWKOczD.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/" aria-label="带我回家"><img class="vp-nav-logo" src="/avatar.jpg" alt><!----><span class="vp-site-name hide-in-pad">悦 ▪ 宝宝</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="主页" iconsizing="height"><!--[--><i class="vp-icon iconfont icon-home" sizing="height"></i><!--]-->主页<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Python"><!--[--><i class="vp-icon iconfont icon-python" sizing="height"></i>Python<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">语言</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/python/%E8%AF%AD%E8%A8%80/%E5%9F%BA%E7%A1%80/%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85.html" aria-label="基础" iconsizing="both"><!---->基础<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/python/%E8%AF%AD%E8%A8%80/%E8%BF%9B%E9%98%B6/%E5%8F%98%E9%87%8F%E6%9C%BA%E5%88%B6.html" aria-label="进阶" iconsizing="both"><!---->进阶<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/python/%E8%AF%AD%E8%A8%80/%E6%B7%B1%E5%85%A5/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6.html" aria-label="深入" iconsizing="both"><!---->深入<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/python/%E8%AF%AD%E8%A8%80/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/Socket.html" aria-label="网络编程" iconsizing="both"><!---->网络编程<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/python/%E8%AF%AD%E8%A8%80/%E5%A4%9A%E4%BB%BB%E5%8A%A1%E7%BC%96%E7%A8%8B/%E8%BF%9B%E7%A8%8B.html" aria-label="多任务编程" iconsizing="both"><!---->多任务编程<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/python/%E8%AF%AD%E8%A8%80/asyncio/asyncio%E5%9F%BA%E7%A1%80.html" aria-label="asyncio" iconsizing="both"><!---->asyncio<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/python/%E8%AF%AD%E8%A8%80/%E5%BA%93/%E6%A0%87%E5%87%86%E5%BA%93%E9%93%BE%E6%8E%A5.html" aria-label="库" iconsizing="both"><!---->库<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">生态</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/python/%E7%94%9F%E6%80%81/Web%E6%A1%86%E6%9E%B6/%E7%BD%91%E7%BB%9C%E6%A1%86%E6%9E%B6%E5%9F%BA%E7%A1%80/WEB%E6%A1%86%E6%9E%B6%E6%9C%AC%E8%B4%A8.html" aria-label="Web框架" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-framework" sizing="both"></i><!--]-->Web框架<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/python/%E7%94%9F%E6%80%81/%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8/gRPC.html" aria-label="远程调用" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-rpc" sizing="both"></i><!--]-->远程调用<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/python/%E7%94%9F%E6%80%81/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka.html" aria-label="消息队列" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-kafka" sizing="both"></i><!--]-->消息队列<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/python/%E7%94%9F%E6%80%81/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/Celery.html" aria-label="异步任务" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-tasks" sizing="both"></i><!--]-->异步任务<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Golang"><!--[--><i class="vp-icon iconfont icon-go" sizing="height"></i>Golang<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">基础</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/go/%E5%9F%BA%E7%A1%80/go%E8%AF%AD%E8%A8%80%E9%80%9F%E8%AE%B0.html" aria-label="go语言速记" iconsizing="both"><!---->go语言速记<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/go/%E5%9F%BA%E7%A1%80/go%E5%B7%A5%E5%85%B7%E9%80%9F%E7%94%A8.html" aria-label="go工具速用" iconsizing="both"><!---->go工具速用<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">算法与数据结构</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/go/%E7%AE%97%E6%B3%95%E4%B8%8E%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E7%BB%84.html" aria-label="数组" iconsizing="both"><!---->数组<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/go/%E7%AE%97%E6%B3%95%E4%B8%8E%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E7%BA%BF%E6%80%A7%E8%A1%A8.html" aria-label="线性表" iconsizing="both"><!---->线性表<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/go/%E7%AE%97%E6%B3%95%E4%B8%8E%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%A0%88%E4%B8%8E%E9%98%9F%E5%88%97.html" aria-label="栈与队列" iconsizing="both"><!---->栈与队列<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/go/%E7%AE%97%E6%B3%95%E4%B8%8E%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%A0%91.html" aria-label="树" iconsizing="both"><!---->树<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="数据库"><!--[--><i class="vp-icon iconfont icon-database" sizing="height"></i>数据库<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/etcd/etcd.html" aria-label="etcd" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-etcd" sizing="both"></i><!--]-->etcd<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/MySQL/MySQL.html" aria-label="MySQL" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-mysql" sizing="both"></i><!--]-->MySQL<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/Redis/redis.html" aria-label="Redis" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-redis" sizing="both"></i><!--]-->Redis<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/PostgreSQL/PostgreSQL.html" aria-label="PostgreSQL" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-postgresql" sizing="both"></i><!--]-->PostgreSQL<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="操作系统"><!--[--><i class="vp-icon iconfont icon-os" sizing="height"></i>操作系统<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/unix/Linux/Linux%E5%9F%BA%E7%A1%80%E6%8C%87%E5%BC%95/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%A6%82%E8%AE%BA.html" aria-label="Linux" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-linux" sizing="both"></i><!--]-->Linux<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/unix/CentOS/%E5%AE%89%E8%A3%85/CentOS%E7%9A%84%E5%AE%89%E8%A3%85.html" aria-label="CentOS" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-centos" sizing="both"></i><!--]-->CentOS<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/unix/Ubuntu/%E4%B8%8B%E8%BD%BD/Ubuntu%E7%B3%BB%E7%BB%9F.html" aria-label="Ubuntu" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-ubuntu" sizing="both"></i><!--]-->Ubuntu<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/unix/%E8%99%9A%E6%8B%9F%E6%9C%BA/PVE/PVE.html" aria-label="虚拟机" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-pve" sizing="both"></i><!--]-->虚拟机<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="运维工具"><!--[--><i class="vp-icon iconfont icon-devops" sizing="height"></i>运维工具<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/tool/Git/Git.html" aria-label="Git" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-git" sizing="both"></i><!--]-->Git<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/tool/Nginx/Nginx%E5%9F%BA%E7%A1%80.html" aria-label="Nginx" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-nginx" sizing="both"></i><!--]-->Nginx<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/tool/Docker/docker%E5%AE%B9%E5%99%A8.html" aria-label="Docker" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-docker" sizing="both"></i><!--]-->Docker<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/tool/Kubernetes/k8s%E8%B5%84%E6%BA%90Pod.html" aria-label="Kubernetes" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-kubernetes" sizing="both"></i><!--]-->Kubernetes<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/tool/Prometheus/%E5%AE%89%E8%A3%85.html" aria-label="Prometheus" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-prometheus" sizing="both"></i><!--]-->Prometheus<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/tool/Other/%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86.html" aria-label="工具" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-other" sizing="both"></i><!--]-->工具<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="漫漫全干卷的苦"><!--[--><!---->漫漫全干卷的苦<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="auto-link external-link" href="https://draveness.me/golang/" aria-label="GO语言设计与实现" rel="noopener noreferrer" target="_blank" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-go" sizing="both"></i><!--]-->GO语言设计与实现<!----></a></li><li class="vp-dropdown-item"><a class="auto-link external-link" href="https://pegasuswang.github.io/LetsGo/basics/01_go_basic_types/basic_types/" aria-label="GO备忘" rel="noopener noreferrer" target="_blank" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-go" sizing="both"></i><!--]-->GO备忘<!----></a></li><li class="vp-dropdown-item"><a class="auto-link external-link" href="https://notes.fe-mm.com/interview/base/types.html" aria-label="前端内卷不归路" rel="noopener noreferrer" target="_blank" iconsizing="both"><!--[--><i class="vp-icon iconfont icon-javascript" sizing="both"></i><!--]-->前端内卷不归路<!----></a></li></ul></button></div></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/Igarashi-G" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable active"><i class="vp-icon iconfont icon-kubernetes" sizing="both"></i><a class="route-link route-link-active auto-link vp-sidebar-title no-external-link-icon" href="/tool/Kubernetes/" aria-label="Kubernetes" iconsizing="both"><!---->Kubernetes<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/tool/Kubernetes/k8s%E5%AE%89%E8%A3%85.html" aria-label="Kubernets 安装(单Master)" iconsizing="both"><!---->Kubernets 安装(单Master)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/tool/Kubernetes/k8s%E8%B5%84%E6%BA%90Pod.html" aria-label="Kubernets - Pod" iconsizing="both"><!---->Kubernets - Pod<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/tool/Kubernetes/k8s%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD.html" aria-label="Kubernets - 工作负载" iconsizing="both"><!---->Kubernets - 工作负载<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/tool/Kubernetes/k8s%E6%9C%8D%E5%8A%A1.html" aria-label="Kubernets - 服务" iconsizing="both"><!---->Kubernets - 服务<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/tool/Kubernetes/k8s%E5%AD%98%E5%82%A8.html" aria-label="Kubernets - 存储" iconsizing="both"><!---->Kubernets - 存储<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/tool/Kubernetes/k8s%E8%BF%9B%E9%98%B6.html" aria-label="Kubernets进阶" iconsizing="both"><!---->Kubernets进阶<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/tool/Kubernetes/Helm%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8.html" aria-label="Helm 安装使用" iconsizing="both"><!---->Helm 安装使用<!----></a></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Kubernets - 服务</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/Igarashi-G" target="_blank" rel="noopener noreferrer">悦·宝宝</a></span><span property="author" content="悦·宝宝"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">2022/10/6</span><meta property="datePublished" content="2022-10-06T00:00:00.000Z"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color0 clickable" role="navigation">运维</span><span class="page-category-item color5 clickable" role="navigation">k8s</span><!--]--><meta property="articleSection" content="运维,k8s"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color5 clickable" role="navigation">k8s</span><!--]--><meta property="keywords" content="k8s"></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 21 分钟</span><meta property="timeRequired" content="PT21M"></span></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><p><strong>k8s</strong> 服务、负载均衡 和 联网</p><h2 id="_1-service-服务" tabindex="-1"><a class="header-anchor" href="#_1-service-服务"><span>1. Service 服务</span></a></h2><p>此时，已能通过 <strong>Deployment</strong> 创建带副本的 <strong>Pod</strong> 提供高可用性的服务了，但即使每个 <strong>Pod</strong> 都会分配单独 <strong>IP</strong>，却存在如下问题</p><ul><li><strong>Pod IP</strong> 仅仅是集群内可见的虚拟 <strong>IP</strong>，外部无法访问</li><li><strong>Pod IP</strong> 会随着 <strong>Pod</strong> 销毁而消失，当 <strong>ReplicaSet</strong> 对 <strong>Pod</strong> 进行动态伸缩时，<strong>Pod IP</strong> 可能随时随地都会变化，对于访问服务带来了难度</li></ul><h4 id="那么什么是-serveice" tabindex="-1"><a class="header-anchor" href="#那么什么是-serveice"><span>那么什么是 Serveice ？</span></a></h4><p><strong>Service</strong> 是一组 <strong>Pod</strong> 的服务抽象（<em>一种可以访问 <strong>Pod</strong> 的策略</em> ），也可以简单理解为逻辑上一组 <strong>Pod</strong> 的 <strong>LB（<em>Load Balance</em>）</strong>，负责将请求分发给对应的 <strong>Pod</strong> ，用来给 <strong>Pod</strong> 通信的</p><p><strong>svc</strong> 一旦创建，即使重建，名称也不会改变</p><h4 id="类型如下" tabindex="-1"><a class="header-anchor" href="#类型如下"><span>类型如下</span></a></h4><ul><li><strong>Cluster IP：</strong> 集群内部使用，默认值，用于负载</li><li><strong>ExternalName：</strong> 返回定义的 <strong>CNAME</strong> 别名，用于反代域名</li><li><strong>NodePort：</strong> 在所有安装了 <strong>kube-proxy</strong> 的节点上，打开一个可供外部访问 <strong>pod</strong> 的端口</li><li><strong>loadBalancer：</strong> 使用云提供商的负载均衡器公开服务 <ul><li>如：阿里、腾讯云支持该格式，发请求并生成 <strong>IP</strong> 地址</li></ul></li></ul><h3 id="_1-1-cluster-ip-负载均衡" tabindex="-1"><a class="header-anchor" href="#_1-1-cluster-ip-负载均衡"><span>1.1 Cluster IP（<em>负载均衡</em> ）</span></a></h3><p><strong>Service</strong> 会为这个 <strong>LB</strong> 提供一个 <strong>Cluster IP</strong> ，使用 <strong>Service</strong> 对象，通过 <strong>selector 进行标签选择</strong>，即可找到对应的 <strong>Pod</strong></p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 每次都输入一串 kubectl xxx太累，可以起别名</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> alias</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kd=&#39;kubectl -n uit&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 此时查看 pod 标签，在 deploy 配置中曾指定了 app=myblog</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kd</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> po</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --show-labels</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                     READY</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   STATUS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    RESTARTS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   AGE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     LABELS</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">mysql-6fbb5cc967-48dfd</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   1/1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Running</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          2d12h</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   app=mysql,pod-template-hash=6fbb5cc967</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ublog-5ff678657f-7qx5z</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   1/1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Running</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          42m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     app=myblog,pod-template-hash=5ff678657f</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ublog-5ff678657f-rk92z</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   1/1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Running</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          43m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     app=myblog,pod-template-hash=5ff678657f</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ublog-5ff678657f-tzspj</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   1/1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Running</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          42m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     app=myblog,pod-template-hash=5ff678657f</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Service</strong> 的 <strong>yaml</strong> 文件如下</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">apiVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">v1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">Service</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">ublog-svc</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">uit</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">spec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  ports</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:					</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 若如 Nginx 有 80、443 则可以指定多个端口</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">80</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				# Service 的端口 </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    protocol</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">TCP</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">			# 协议: UDP、TCP、SCTP  default: TCP</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    targetPort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">8002</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		# 后端应用的端口（容器服务的）</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  selector</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    app</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">myblog</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				# 通过标签过滤并选择应用</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">ClusterIP</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如上配置端口，<strong>ServiceA</strong> 访问 <strong>ServiceB</strong> 可利用 <code>servicea --&gt; serviceb http://serviceb</code>，若端口非 <strong>80</strong> , 假如是 <strong>8080</strong> 则通过 <code>http://serviceb:8080</code> 即可</p><p>创建 <strong>Service</strong> 并查看</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 创建 svc</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> create</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -f</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc-ublog.yaml</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">service/svc-ublog</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> created</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看 svc，此时已创建了 CLUSTER-IP 10.105.146.135 80 端口的服务（建议自动生成 ClusterIP 而非指定）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -nuit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        TYPE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        CLUSTER-IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       EXTERNAL-IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   PORT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">S</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)   </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">AGE</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">svc-ublog</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   ClusterIP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.105.146.135</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">80/TCP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    7m51s</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看详情，此时发现 endpoints 已经代理了对应的 app = myblog</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -nuit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> describe</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Name:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">              svc-ublog</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Namespace:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         uit</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Labels:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Annotations:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Selector:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          app=myblog</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Type:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">              ClusterIP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">IP:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">                10.105.146.135</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Port:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">              &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">unse</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">t&gt;  </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">80/TCP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">TargetPort:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        8002/TCP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Endpoints:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         10.244.1.35:8002,10.244.2.32:8002,10.244.2.33:8002</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Session</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Affinity:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  None</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Events:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 此时访问 80 端口，服务正常</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">curl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.105.146.135/blog/index/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 缩容 ublog 服务</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> scale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> deploy</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ublog</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --replicas=2</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">deployment.apps/ublog</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> scaled</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看svc详情，此时发现 endpoints 自动减一</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> describe</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Name:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">              svc-ublog</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Namespace:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         uit</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Labels:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Annotations:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Selector:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          app=myblog</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Type:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">              ClusterIP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">IP:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">                10.105.146.135</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Port:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">              &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">unse</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">t&gt;  </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">80/TCP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">TargetPort:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        8002/TCP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Endpoints:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         10.244.1.35:8002,10.244.2.32:8002</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Session</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Affinity:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  None</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Events:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>创建 <strong>Service</strong> 时，若配置标签选择 <strong>pod</strong> ，会收集其 <strong>IP</strong>，自动创建同名的 <strong>endpoints</strong> 对象，若 <strong>Pod</strong> 上配置了 <strong>readinessProbe</strong>，检测失败时，<strong>endpoints</strong> 列表会剔除掉对应的 <strong>Pod IP</strong>，这样流量就不会分发到健康检测失败的 <strong>Pod</strong> 上</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> endpoints</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc-ublog</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        ENDPOINTS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                           AGE</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">svc-ublog</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   10.244.1.35:8002,10.244.2.32:8002</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   21m</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>再次改造 <strong>MySQL</strong>，创建 <strong>Service</strong></p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">apiVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">v1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">Service</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">svc-mysql</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">uit</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">spec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  ports</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3306</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    protocol</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">TCP</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    targetPort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3306</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  selector</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    app</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">mysql</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">ClusterIP</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建并访问</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> create</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -f</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc-mysql.yaml</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">service/mysql</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> created</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc-mysql</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        TYPE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        CLUSTER-IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     EXTERNAL-IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   PORT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">S</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">AGE</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">svc-mysql</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   ClusterIP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.98.22.166</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">3306/TCP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   21s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> curl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.98.22.166:3306</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">若用 hostNetwork 部署，通过宿主机 ip:port 形式访问，会有如下弊端</p><ul><li>服务使用 <strong>hostNetwork</strong>，使得宿主机的端口大量暴漏，<strong>存在安全隐患</strong></li><li>容易引发端口冲突</li></ul><p>因此，应该为 <strong>MySQL</strong> 创建 <strong>Service</strong>，并配到 <strong>ublog</strong> 的环境变量中，利用集群服务发现的能力，组件间通过 <strong>Service Name</strong> 访问</p></div><h3 id="_1-2-服务发现-环境变量去-ip-化" tabindex="-1"><a class="header-anchor" href="#_1-2-服务发现-环境变量去-ip-化"><span>1.2 服务发现（<em>环境变量去 IP 化</em> ）</span></a></h3><p><strong>k8s</strong> 集群中，组件间可以通过 <strong>Service Name</strong> 实现通信，<strong>Pods</strong> 间，无需通过 <strong>固定环境变量 IP</strong> 的形式</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看上文创建的 svc</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc-mysql</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        TYPE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        CLUSTER-IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     EXTERNAL-IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   PORT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">S</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">AGE</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">svc-mysql</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   ClusterIP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.98.22.166</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">3306/TCP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   151m</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 访问任意一个业务 pod ublog</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> exec</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -ti</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ublog-5ff678657f-rk92z</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># curl cluster ip，可正常连通 MySQL</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">curl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.98.22.166:3306</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># curl svc-mysql，发现依然可正常连通 MySQL，</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">curl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc-mysql:3306</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>尽管 <strong>Pod IP</strong> 和 <strong>Cluster IP</strong> 都不固定（<em><strong>重启会变更</strong></em> ），但 <strong>Service Name</strong> 是固定的，且完全具有跨集群的可移植性，实现原理如下</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看当前的 DNS 配置，发现有个 10.96.0.10 的 IP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/resolv.conf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nameserver</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.96.0.10</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">search</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uit.svc.cluster.local</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc.cluster.local</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cluster.local</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">options</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ndots:5</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 退出容器，并查看所有命名空间，发现 kube-system 下有个 kube-dns，它的 IP 刚好同上</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --all-namespaces</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAMESPACE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">              NAME</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                        TYPE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        CLUSTER-IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       EXTERNAL-IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   PORT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">S</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)                  </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">AGE</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">default</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                kubernetes</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                  ClusterIP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.96.0.1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">443/TCP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                  23d</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">kube-system</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            kube-dns</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                    ClusterIP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.96.0.10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">53/UDP,53/TCP,9153/TCP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   23d</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">kubernetes-dashboard</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   dashboard-metrics-scraper</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   ClusterIP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.96.54.184</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">8000/TCP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                 22d</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">kubernetes-dashboard</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   kubernetes-dashboard</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        NodePort</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">    10.97.63.15</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">443:30100/TCP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            22d</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">uit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                    svc-mysql</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                   ClusterIP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.98.22.166</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">3306/TCP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                 157m</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">uit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                    svc-ublog</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                   ClusterIP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.105.146.135</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">80/TCP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                   3h5m</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看 kube-dns 这个 Service 详情，发现选择器 Selector 选了 k8s-app=kube-dns 这个标签</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kube-system</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> describe</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kube-dns</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Name:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">              kube-dns</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Namespace:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         kube-system</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Labels:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            k8s-app=kube-dns</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                   kubernetes.io/cluster-service</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">=</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">true</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                   kubernetes.io/name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">=KubeDNS</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Annotations:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       prometheus.io/port:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 9153</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                   prometheus.io/scrape:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Selector:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          k8s-app=kube-dns</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Type:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">              ClusterIP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">IP:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">                10.96.0.10</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Port:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">              dns</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  53/UDP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">TargetPort:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        53/UDP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Endpoints:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         10.244.0.5:53,10.244.0.6:53</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Port:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">              dns-tcp</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  53/TCP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">TargetPort:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        53/TCP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Endpoints:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         10.244.0.5:53,10.244.0.6:53</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Port:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">              metrics</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  9153/TCP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">TargetPort:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        9153/TCP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Endpoints:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         10.244.0.5:9153,10.244.0.6:9153</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Session</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Affinity:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  None</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Events:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 根据 选择器的标签过滤 找Pod，发现是初始化时的 coredns </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kube-system</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> po</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -l</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> k8s-app=kube-dns</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -owide</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                       READY</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   STATUS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    RESTARTS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   AGE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">           NODE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">             NOMINATED</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> NODE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   READINESS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> GATES</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">coredns-58cc8c89f4-hzprn</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   1/1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Running</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          23d</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.244.0.5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   k8s-master-171</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;           &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">coredns-58cc8c89f4-vvj77</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   1/1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Running</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          23d</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.244.0.6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   k8s-master-171</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;           &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">初始化时创建了</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> coredns 然后建立 kube-dns 这个service（固定IP），后续新建 Pod 便可注入到 DNS 配置中，最终解析的就是 coredns 的 IP, coredns 见 </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2.4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>故容器内部组件间调用，完全可以通过 <strong>Service Name</strong>（类似域名）来解析 <strong>IP</strong> 通信，避免了大量 <strong>IP</strong> 维护的成本，因此再次对部署进行优化改造</p><ol><li><p><strong>MySQL</strong> 去掉 <strong>hostNetwork</strong> 部署，使得服务只暴露在 <strong>k8s</strong> 集群内部网络环境中</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">...</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">hostNetwork</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">false</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">			# 去掉此行 或 改为false</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>configMap</strong> 中的数据库 <strong>HOST</strong> 固定的 <strong>IP</strong> 地址换成 <strong>Service Name</strong>，这样跨环境时，配置内容可保持不变</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">apiVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">v1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">ConfigMap</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">ublog</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">uit</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  MYSQL_HOST</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;svc-mysql&quot;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     # 此处替换为上文给 MySQL 创建的 Service</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  MYSQL_PORT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;3306&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重新执行</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apply</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -f</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> configmap.yaml</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apply</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -f</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> deploy-mysql.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 也可以删除 configmap 再通过 .txt 重建</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> delete</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cm</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ublog</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> create</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> configmap</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ublog</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --from-env-file=configmap.txt</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><div class="hint-container tip"><p class="hint-container-title">提示</p><p>同一个 <strong>NameSpace</strong> 下，可以直接通过 <strong>ServiceName</strong> 来进行访问，而跨 <strong>NameSpace</strong> 访问，需要 <strong>ServiceName + 后缀 .namespace</strong> 的方式访问</p></div><h3 id="_1-3-nodeport-外部访问" tabindex="-1"><a class="header-anchor" href="#_1-3-nodeport-外部访问"><span>1.3 NodePort（<em>外部访问</em> ）</span></a></h3><p><strong>Cluster IP</strong> 为虚拟地址，只能在 <strong>k8s</strong> 集群内部进行访问，集群外部如果访问内部服务，可以配置 <strong>NodePort</strong></p><p>若不指定 <strong>NodePort</strong> 端口，则会默认在 <strong>30000-32767（<em>端口号</em> ）</strong> 中随机使用其中一个</p><h4 id="使用场景" tabindex="-1"><a class="header-anchor" href="#使用场景"><span>使用场景</span></a></h4><p>通常用于 <strong>临时</strong> 需要访问 <strong>MySQL</strong> 之类的中间件才使用，性能差，<strong>不推荐使用</strong></p><ul><li><strong>Service</strong> 一旦变多，其性能也随之大幅下降</li><li>维护各种端口的成本过高、太复杂，推荐使用 <strong>ingress</strong></li></ul><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">apiVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">v1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">Service</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">svc-np-ublog</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">uit</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">spec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  ports</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">80</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    protocol</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">TCP</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    targetPort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">8002</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    nodePort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32333</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				# 这里还是手动指定了端口 32333 看效果</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  selector</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    app</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">myblog</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">NodePort</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				# 只需将之前的 Cluster IP 改为 NodePort 即可</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建并查看服务</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 创建 svc</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> create</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -f</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc-np-ublog.yaml</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">service/svc-np-ublog</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> created</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看当前服务</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">           TYPE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        CLUSTER-IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       EXTERNAL-IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   PORT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">S</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)        </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">AGE</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">svc-mysql</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      ClusterIP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.98.22.166</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">3306/TCP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       2d11h</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">svc-np-ublog</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   NodePort</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">    10.107.82.31</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">80:32543/TCP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   4m57s</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">svc-ublog</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      ClusterIP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.105.146.135</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">80/TCP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         2d11h</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看详情</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> describe</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc-np-ublog</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Name:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                     svc-np-ublog</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Namespace:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                uit</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Labels:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                   &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Annotations:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">              &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Selector:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                 app=myblog</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Type:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                     NodePort</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">IP:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">                       10.107.82.31</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Port:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                     &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">unse</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">t&gt;  </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">80/TCP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">TargetPort:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">               8002/TCP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NodePort:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                 &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">unse</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">t&gt;  </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">32543/TCP</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Endpoints:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                10.244.1.35:8002,10.244.2.32:8002</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Session</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Affinity:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         None</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">External</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Traffic</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Policy:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  Cluster</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Events:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                   &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时发现类型变为 <code>Type: NodePort</code> ，且多了随机的端口 <code>NodePort: &lt;unset&gt; 32543/TCP</code>，但 <strong>CLUSTER-IP</strong> 和 <strong>Endpoints</strong> 依然没变</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 故可删除之前的 svc</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> delete</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -f</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc-ublog.yaml</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">service</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;svc-ublog&quot;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> deleted</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 同时发现，集群内每个节点的 NodePort 端口都会进行监听</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> curl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.3.171:32333/blog/index/</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> curl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.3.172:32333/blog/index/</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> curl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.3.173:32333/blog/index/</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>k8s</strong> 集群的 <strong>业务 Pod</strong> 变为类似 <strong>高可用</strong> 一样，都能在浏览器上，通过每个节点的 <strong>IP</strong>，对服务进行外部访问（<em>即使该节点未跑对应的业务 Pod</em> ）</p><ul><li><a href="http://192.168.3.171:32333/blog/index/" target="_blank" rel="noopener noreferrer">http://192.168.3.171:32333/blog/index/</a></li><li><a href="http://192.168.3.172:32333/blog/index/" target="_blank" rel="noopener noreferrer">http://192.168.3.172:32333/blog/index/</a></li><li><a href="http://192.168.3.173:32333/blog/index/" target="_blank" rel="noopener noreferrer">http://192.168.3.173:32333/blog/index/</a></li></ul><div class="hint-container note"><p class="hint-container-title">此时会有如下疑惑？</p><ol><li><strong>NodePort</strong> 的端口监听，是如何转发到对应的 <strong>Pod</strong> 服务的？</li><li><strong>CLUSTER-IP</strong> 是 <strong>虚拟 IP</strong>，集群内是如何通过这个 <strong>虚拟 IP</strong> 访问到具体的 <strong>Pod</strong> 服务的？</li></ol></div><h3 id="_1-4-service-实现原理" tabindex="-1"><a class="header-anchor" href="#_1-4-service-实现原理"><span>1.4 Service 实现原理</span></a></h3><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看 32333 端口的监听，看到如下 kube-proxy 在监听</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> netstat</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -ntpl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> |</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">grep</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 32333</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tcp6</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">       0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">      0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> :::32333</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                :::</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">*</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                    LISTEN</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      28426/kube-proxy</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="coredns" tabindex="-1"><a class="header-anchor" href="#coredns"><span>CoreDNS</span></a></h4><p>用于 <strong>k8s</strong> 集群内部 <strong>Service</strong> 的解析，可以让 <strong>Pod</strong> 把 <strong>Service</strong> 名称解析为 <strong>IP</strong> 地址，然后通过 <strong>IP</strong> 连接到对应的应用上</p><div class="hint-container tip"><p class="hint-container-title">提示</p><ul><li><p><strong>Go</strong> 语言实现的链式插件，<strong>CNCF</strong> 成员，是个高性能、易扩展的 <strong>DNS</strong> 服务端</p></li><li><p>生产环境中，一定要启用多个，应对集群规模</p></li></ul></div><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看 coredns</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kube-system</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> po</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> wide</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">|</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">grep</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dns</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">coredns-58cc8c89f4-hzprn</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                 1/1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Running</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          28d</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.244.0.5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      k8s-master-171</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;           &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">coredns-58cc8c89f4-vvj77</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                 1/1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Running</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          28d</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.244.0.6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      k8s-master-171</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;           &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 进入 myblog 的 pod ，查看 DNS解析</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> exec</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -ti</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ublog-5ff678657f-7qx5z</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bash</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/resolv.conf</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nameserver</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.96.0.10</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">search</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uit.svc.cluster.local</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc.cluster.local</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cluster.local</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">options</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ndots:5</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 10.96.0.10 怎么来的， 查看svc 发现有 kube-dns 服务 </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># .10是默认给 dns用的</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kube-system</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       TYPE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        CLUSTER-IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   EXTERNAL-IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   PORT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">S</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)                  </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">AGE</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">kube-dns</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   ClusterIP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.96.0.10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">53/UDP,53/TCP,9153/TCP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   28d</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># .1 网段是默认给 Kubernetes 用的</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         TYPE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        CLUSTER-IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   EXTERNAL-IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   PORT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">S</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)   </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">AGE</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">kubernetes</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   ClusterIP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.96.0.1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">443/TCP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   28d</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>启动 <strong>Pod</strong> 的时，会把 <strong>kube-dns</strong> 服务的 <strong>Cluster IP</strong> 地址注入到 <strong>Pod</strong> 的 <strong>resolve</strong> 解析配置中</li><li>同时添加对应 <strong>namespace</strong> 的 <strong>search</strong> 域（<em>后面的一连串域名</em> ）</li><li>因此通过 <strong>service name 跨命名空间访问</strong> 的话，需要添加对应的 <strong>namespace</strong> 名称 <ul><li>如： <code>service_name.namespace_name</code></li></ul></li></ul><h4 id="kube-proxy" tabindex="-1"><a class="header-anchor" href="#kube-proxy"><span>kube-proxy</span></a></h4><p><a href="https://kubernetes.io/docs/concepts/services-networking/service/#virtual-ips-and-service-proxies" target="_blank" rel="noopener noreferrer">官方文档</a> 未来也许会被 <strong>Cilium</strong> 、 <strong>eBPF（<em>机制</em> ）</strong> 原生替代</p><p><strong>运行在每个节点上</strong>， 负责 <strong>Pod</strong> 间的 <strong>通信</strong> 和 <strong>负载均衡</strong>，监听 <strong>API Server</strong> 中服务对象的变化，再通过创建流量路由规则来实现网络的转发，有如下模式</p><ul><li><p><s><strong>User space</strong>, 让 Kube-Proxy 在用户空间监听一个端口，所有的 Service 都转发到这个端口，然后 Kube-Proxy 在内部应用层对其进行转发 ， 所有报文都走一遍用户态，性能不高，k8s v1.2版本后废弃</s>。</p></li><li><p><strong>Iptables：</strong> 当前默认模式，<strong>完全由 IPtables 来实现</strong>， 通过各个节点上的 <strong>iptables</strong> 规则来实现 <strong>service</strong> 的负载均衡，但是随着 <strong>service</strong> 数量的增大，<strong>iptables</strong> 模式由于线性查找匹配、全量更新等特点，其性能会显著下降</p></li><li><p><strong>IPVS：</strong> 监听 <strong>Master</strong> 节点 增加和删除 <strong>service</strong> 以及 <strong>endpoint</strong> 的消息，调用 <strong>Netlink</strong> 创建对应 <strong>IPVS</strong> 规则，将流量转发到对应的 <strong>Pod</strong> 上</p><ul><li>与 <strong>iptables</strong> 同样基于 <strong>Netfilter（<em>iptable内核态的一种实现</em>）</strong>，采用 <strong>hash</strong> 表，因此当 <strong>service</strong> 数量达到一定规模时，<strong>hash</strong> 查表速度快，从而提高 <strong>service</strong> 的服务性能</li><li><strong>k8s 1.8</strong> 版本开始引入，<strong>1.11</strong> 版本开始稳定，需要开启宿主机的 <strong>ipvs</strong> 模块</li></ul><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 客户端工具 查看 配置规则</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ipvsadm</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -ln</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h5 id="iptables-抓包流程" tabindex="-1"><a class="header-anchor" href="#iptables-抓包流程"><span><strong>Iptables 抓包流程</strong></span></a></h5><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看 svc-np-ublog 的 iptables</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> iptables-save</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  |</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">grep</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc-np-ublog</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-A</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-NODEPORTS</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tcp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> comment</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --comment</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;uit/svc-np-ublog:&quot;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tcp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --dport</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 32333</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -j</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-MARK-MASQ</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-A</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-NODEPORTS</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tcp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> comment</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --comment</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;uit/svc-np-ublog:&quot;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tcp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --dport</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 32333</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -j</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SVC-FQQJWIJEBH5A6SF6</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-A</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SERVICES</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> !</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.244.0.0/16</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -d</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.107.82.31/32</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tcp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> comment</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --comment</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;uit/svc-np-ublog: cluster IP&quot;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tcp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --dport</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 80</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -j</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-MARK-MASQ</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-A</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SERVICES</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -d</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.107.82.31/32</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tcp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> comment</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --comment</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;uit/svc-np-ublog: cluster IP&quot;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tcp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --dport</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 80</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -j</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SVC-FQQJWIJEBH5A6SF6</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">将IP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.107.82.31</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 转发到 80端口，转向 KUBE-SVC-FQQJWIJEBH5A6SF6 这个链`</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 继续抓链</span></span>
<span class="line highlighted"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> iptables-save</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">|</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">grep</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SVC-FQQJWIJEBH5A6SF6</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">:KUBE-SVC-FQQJWIJEBH5A6SF6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [0:0]</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">...</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-A</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SVC-FQQJWIJEBH5A6SF6</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> statistic</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --mode</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> random</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --probability</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0.50000000000</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -j</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SEP-U4JA5WF5RRIRERN5</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-A</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SVC-FQQJWIJEBH5A6SF6</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -j</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SEP-ME7MACTOWWVFKRBM</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">静态</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 模式 随机 50%的可能性 打到 KUBE-SEP-U4JA5WF5RRIRERN5 链上`</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 进一步抓取 KUBE-SEP-U4JA5WF5RRIRERN5</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> iptables-save</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">|</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">grep</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SEP-U4JA5WF5RRIRERN5</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">:KUBE-SEP-U4JA5WF5RRIRERN5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [0:0]</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-A</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SEP-U4JA5WF5RRIRERN5</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.244.1.35/32</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -j</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-MARK-MASQ</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-A</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SEP-U4JA5WF5RRIRERN5</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tcp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tcp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -j</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> DNAT</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --to-destination</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.244.1.35:8002</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-A</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SVC-FQQJWIJEBH5A6SF6</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> statistic</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --mode</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> random</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --probability</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0.50000000000</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -j</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SEP-U4JA5WF5RRIRERN5</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">此时</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> DNAT 到了具体的 Pod IP 10.244.1.35:8002 上`</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># KUBE-SEP-ME7MACTOWWVFKRBM 也是如此</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">iptables-save</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">|</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">grep</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SEP-ME7MACTOWWVFKRBM</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">:KUBE-SEP-ME7MACTOWWVFKRBM</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [0:0]</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-A</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SEP-ME7MACTOWWVFKRBM</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.244.2.32/32</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -j</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-MARK-MASQ</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-A</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SEP-ME7MACTOWWVFKRBM</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tcp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tcp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -j</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> DNAT</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --to-destination</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.244.2.32:8002</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-A</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SVC-FQQJWIJEBH5A6SF6</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -j</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> KUBE-SEP-ME7MACTOWWVFKRBM</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时发现是按照 <strong>Pod</strong> 进行流量分配的，若要 <strong>灰度发布</strong>，做 <strong>流量分配 / 治理</strong> 仍无法实现，需要 <strong>istio</strong></p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 重建 pod</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> demo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> delete</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> po</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mysql-7f747644b8-6npzn</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 去掉 taint</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> taint</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> node</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> k8s-slave1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> smoke-</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> taint</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> node</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> k8s-slave2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> drunk-</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># myblog不用动，会自动因健康检测不过而重启</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-5-endpoints-代理外部应用-代理" tabindex="-1"><a class="header-anchor" href="#_1-5-endpoints-代理外部应用-代理"><span>1.5 Endpoints 代理外部应用（<em>代理</em> ）</span></a></h3><p>经常有需要代理 <strong>k8s</strong> 外部应用的需求，<strong>应用场景如下</strong></p><ul><li>希望在生产环境上使用固定名称（<em>如：服务名</em> ），而非通过 <strong>IP</strong> 地址去访问外部的中间件服务 <ul><li>如: 不希望各团队维护不同 <strong>k8s</strong> 集群时，还维护各种中间件的配置文件，此时可以直接通过 <strong>svc</strong> 反代来统一配置文件</li></ul></li><li>希望 <strong>Service</strong> 指向另一个<strong>NameSpace</strong> 中或 <strong>其他集群</strong> 中的服务 <ul><li>比如: <strong>一些外部的存储集群的管理平台</strong> 不去部署于 <strong>k8s</strong> 中，此时也可通过 <strong>k8s</strong> 的服务进行代理</li><li>跨命名空间时不想使用 <strong>.namespace</strong> 后缀形式访问（<em>不推荐</em> ）</li></ul></li><li>某个项目正在迁移至 <strong>k8s</strong> 集群，但一部分服务依然在集群外，此时可使用 <strong>Service</strong> 代理至 <strong>k8s</strong> 集群外部的服务（<em>避免迁移重启</em> ） <ul><li>比如：之前 <strong>Web</strong> 通过 <strong>172.16.120.111</strong> 形式访问数据库，<strong>Web</strong> 迁过来改为通过 <strong>Service 代理形式</strong> 访问，再将数据库迁移过来时无需重启 <strong>Web</strong> 服务</li></ul></li></ul><h4 id="反代-ip" tabindex="-1"><a class="header-anchor" href="#反代-ip"><span>反代 IP</span></a></h4><p>以代理百度为例，先编写 <strong>svc</strong> 文件</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">$ kubectl -n dev get svc -o yaml &gt; svc-proxy.yaml</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">$ vim svc-proxy.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">---</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">-------------------------</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">apiVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">v1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">Services</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  label</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    app</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">svc-poroxy</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">svc-proxy</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">dev</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">spce</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  ports</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">http</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">80</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    protocol</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">TCP</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    targetPort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">80</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  sessionAffinity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">None</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">ClusterIP</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">---</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">-------------------------</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">$ kubectl create -f svc-proxy.yaml</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">$ kubectl -n dev get svc</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">NAME        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">svc-nignx   ClusterIP   None             &lt;none&gt;        80/TCP    29d</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">svc-proxy   ClusterIP   10.100.128.239   &lt;none&gt;        80/TCP    11h</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时查看 <strong>svc</strong> 可获取自动分配的 <strong>IP</strong>，接下来编写 <strong>endpoints</strong> 来关联代理</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 先获取百度目前的IP</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">$ ping www.baidu.com</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">64 bytes from 14.215.177.38 (14.215.177.38)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">icmp_seq=1 ttl=56 time=6.87 ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 编写 endpoints</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">$ vim ep-proxy.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">---</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">-------------------------</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">apiVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">v1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">Endpoints</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  label</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    app</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">svc-poroxy</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		# 需和 svc 的一致来进行关联</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">svc-proxy</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">dev</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">subsets</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:				</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">- </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">addresses</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">14.215.177.38</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	# 填写代理的IP地址</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  ports</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">http</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">80</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    protocol</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">TCP</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		# 协议需和 svc 的一致</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">---</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">-------------------------</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">$ kubectl apply -f ep-proxy.yaml</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#此时 svc 关联的 ep 已生成，且会随着 svc 的消失而消失</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">$ kubectl -n dev get ep</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># curl svc 的 IP 此时发现有相应</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">$ curl 10.100.128.239 -I</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>若更换了 <strong>IP</strong> 无需重启应用程序，只需要改动 <strong>endpoints</strong> 文件的 <code>ip</code> ，然后 <code>kubectl replace -f</code> 即可</p><h4 id="externalname-反代域名" tabindex="-1"><a class="header-anchor" href="#externalname-反代域名"><span>ExternalName（<em>反代域名</em> ）</span></a></h4><p>若需反代域名，则需要更改 <strong>svc</strong> 的类型为 <strong>ExternalName</strong></p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">vim svc-proxyName.yaml</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">---</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">-------------------------</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">apiVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">v1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">Service</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  labels</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    app</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">svc-proxy-name</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">svc-proxy-name</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">dev</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">spec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">ExternalName</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  externalName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">www.baidu.com</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">---</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">-------------------------</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">$ kubectl apply -f svc-proxyName.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时进入 <strong>busybox</strong> 中尝试通过代理的服务名访问</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -ndev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> exec</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -ti</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> busybox</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 通过代理的域名请求资源，访问不通是由于跨域造成的</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> wget</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc-proxy-name</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Connecting</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc-proxy-name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (14.215.177.38:80)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">wget:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> server</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> returned</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> error:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> HTTP/1.1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 403</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Forbidden</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 域名解析</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> nslookup</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> svc-proxy-name</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Server:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">    10.96.0.10</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Address</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.96.0.10</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Name:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      svc-proxy-name</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Address</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 14.215.177.38</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Address</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 2:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 14.215.177.39</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 直接请求，则可通过</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> wget</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 14.215.177.38</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Connecting</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 14.215.177.38</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (14.215.177.38:80)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">index.html</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">           100%</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> |*****************************]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于跨域问题，该场景使用较少</p><h2 id="_2-ingress-流量路由" tabindex="-1"><a class="header-anchor" href="#_2-ingress-流量路由"><span>2. Ingress（<em>流量路由</em> ）</span></a></h2><p><a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener noreferrer">官方文档</a></p><p>同 <strong>k8s</strong> 的资源类型，对于 <strong>k8s</strong> 的 <strong>Service</strong>，无论是 <strong>Cluster IP</strong> 还是 <strong>NodePort</strong>，都是 <strong>四层负载</strong>，要让集群内的服务实现 <strong>七层负载均衡</strong>，要借助于 <strong>Ingress</strong></p><ul><li><strong>Ingress 控制器：</strong> 其实现方式很多，比如 <strong>Nginx</strong>, <strong>Contour</strong>, <strong>Haproxy</strong>, <strong>trafik</strong>, <strong>Istio</strong>，后续 <strong>Nginx</strong> 实现为例</li><li><strong>发布方式：</strong><ul><li>它既可以实现 <strong>端口</strong> 的方式，同时可以实现 <strong>域名</strong> 的方式访问 <strong>k8s</strong> 内部应用</li><li>通常内部通过域名，反代到业务节点，<strong>ingress</strong> 上层可能还有 <strong>F5</strong>，<strong>LVS</strong>，<strong>SLB</strong>，<strong>ELB</strong> 等作为入口再反代到<strong>ingress</strong> 上，然后 <strong>将购买的 域名 解析到 F5、阿里云等LB上</strong></li><li>由于是 <strong>k8s</strong> 中通过 <strong>IPVS</strong> 实现的一种 <strong>内核级</strong> 的转发，因此还是很快的，今后可能还使用 <strong>EBPF</strong> 等东西，速度更快</li></ul></li></ul><h3 id="_2-1-ingress-nginx-安装" tabindex="-1"><a class="header-anchor" href="#_2-1-ingress-nginx-安装"><span>2.1 Ingress-nginx 安装</span></a></h3><p>是 <strong>k8s</strong> 官方维护的控制器（<em>同步更新</em> ）<a href="https://kubernetes.github.io/ingress-nginx/" target="_blank" rel="noopener noreferrer">官方文档</a></p><p><strong>Ingress-nginx</strong> 是 <strong>7 层的负载均衡器</strong> ，负责统一管理外部对 <strong>k8s cluster</strong> 中 <strong>Service</strong> 的请求，包含如下</p><ul><li><strong>ingress-nginx-controller：</strong> 根据用户编写的 <strong>ingress</strong> 规则（<em>创建的 ingress 的 yaml 文件</em> ），动态的去更改<strong>nginx</strong> 服务的配置文件，并且 <strong>reload</strong> 重载使其生效（<em>是自动化的，通过 lua 脚本来实现</em> ）</li><li><strong>ingress资源对象：</strong> 将 <strong>Nginx</strong> 的配置抽象成一个 <strong>Ingress</strong> 对象，每添加一个新的 <strong>Service</strong> 资源对象只需写一个新的 <strong>Ingress</strong> 规则的 <strong>yaml</strong> 文件即可（<em>或修改已存在的 ingress 规则的 yaml 文件</em> ）</li></ul><p><a href="https://kubernetes.github.io/ingress-nginx/deploy/" target="_blank" rel="noopener noreferrer">Ingress-nginx 官方文档</a> ，推荐使用 <strong><a class="route-link" href="/tool/Kubernetes/Helm%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8.html">Helm</a></strong> 安装</p><p><a href="https://artifacthub.io/packages/helm/ingress-nginx/ingress-nginx" target="_blank" rel="noopener noreferrer">Artifact Hub中查找</a> 这是来源于 <strong>Kubernetes</strong> 维护的官方 <strong>Helm</strong> 仓库</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 通过 helm 添加 ingress-nginx 仓库</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> helm</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> repo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress-nginx</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> https://kubernetes.github.io/ingress-nginx</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看添加的仓库</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> helm</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> repo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> list</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         	URL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                                          </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ingress-nginx</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">	https://kubernetes.github.io/ingress-nginx</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看仓库中 ingress-nginx 的版本</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> helm</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> search</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> repo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress-nginx</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                       	CHART</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> VERSION</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">	APP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> VERSION</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">	DESCRIPTION</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ingress-nginx/ingress-nginx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">	4.4.0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">        	1.5.1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      	Ingress</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> controller</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Kubernetes</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> using</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> NGINX</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> a...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 虽然需要 APP VERSION &gt;= 0.40.2 (bug少)，但是  CHART VERSION 4.4.0 太高了，安装会报错，</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时要下 <strong>降级</strong> 的包，这里是 <strong>CHART VERSION == 3.18.0</strong></p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 通过命令 search 所有版本的包</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> helm</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> search</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> repo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress-nginx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -l</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">...</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ingress-nginx/ingress-nginx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">	3.18.0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">        	0.42.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     	An</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> nginx</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Ingress</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> controller</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> that</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uses</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ConfigMap...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># pull 包指定版本号</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> helm</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> pull</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress-nginx/ingress-nginx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --version</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3.18.0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 网络失败，多试几次，下载后会多出个 3.18.0 的 tar 包</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ls</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">anaconda-ks.cfg</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  `</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ingress-nginx-3.18.0.tgz</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  k8s_install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  kube-prometheus</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  prom</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  test</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 解压，进入目录</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tar</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -xf</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress-nginx-3.18.0.tgz</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cd</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress-nginx/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 如下是配置文件</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ls</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">CHANGELOG.md</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  Chart.yaml</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  ci</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  OWNERS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  README.md</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  README.md.gotmpl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  templates</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  values.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改 <strong>ingress</strong> 配置文件</p><div class="language-ini line-numbers-mode" data-highlighter="shiki" data-ext="ini" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 打开 values.yaml 修改镜像地址等配置</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">$ vim values.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">------------------------------</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 修改镜像源地址，并去掉哈希值</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">+ repository: docker.io/willdockerhub/ingress-nginx-controller</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">- digest </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 推荐使用 hostNetwork 部署，走宿主机端口，性能好一些, 且推荐使用 DaemonSet部署</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">+ dnsPolicy: ClusterFirstWithHostNet</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">+ hostNetwork: true</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">+ kind: DaemonSet</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 必须修改 dns 策略 否则 ingress pod 是解析不了 k8s 内部的 Service</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 设置有 ingress 为 true 标签的节点才部署</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">nodeSelector:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">kubernetes.io/os: linux</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">+ ingress: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;true&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 生产环境中建议修改 resources 需要给大点，毕竟是 k8s 的入口</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 非云环境，type 是不需要使用 LoadBalancer 的，IDC 机房直接使用 ClusterIP 即可</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">+ type: ClusterIP</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 云的话，会向云发个请求，然后得到公有云分配的 IP 地址，之后将购买的域名解析到公有云的 IP 即可</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看转轴控制 是否证书会报错 0.42 前会，将 enabled 修改</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">admissionWebhooks:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">  enabled: ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># kube-webhook-certgen 的镜像地址同样修改</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">+ repository: egistry.aliyuncs.com/google_containers/kube-webhook-certgen</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">------------------------------</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 如上镜像地址都是网上抄的，若 pull 失败，百度下载离线</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">docker pull quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.xx.0</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">docker pull 能用的国内地址/k8s/defaultbackend-amd64:x.xx</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">注意</p><p>若使用 <strong>Deployment</strong> 方式部署，则不使用 <strong>hostNetwork</strong>，因为是随机部署的，可能部署在同一个宿主机导致端口冲突</p><p><strong>DaemonSet</strong> 更容易控制与某个节点，直接在宿主机上暴露端口号，<strong>k8s</strong> 外部的负载均衡，可以直接代理到 <strong>ingress</strong> 所在节点的 <strong>IP</strong> 和端口号上，而使用 <strong>Deployment + NodePort</strong> 方式性能差难维护</p></div><p>使用 <strong>Helm</strong> 安装</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 创建命名空间并安装</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> create</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ns</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress-nginx</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># -n 指定 namespace</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> helm</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress-nginx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress-nginx</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> .</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 出现如下，貌似密码 base64 转码啥的</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAME:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress-nginx</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">...</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">If</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> TLS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> is</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> enabled</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Ingress,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> a</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Secret</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> containing</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> certificate</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> and</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> key</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> must</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> also</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> be</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> provided:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  apiVersion:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> v1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  kind:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Secret</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  metadata:</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    name:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> example-tls</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    namespace:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> foo</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  data:</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    tls.crt:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">base64</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> encoded</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">t&gt;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    tls.key:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">base64</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> encoded</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ke</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">y&gt;</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">  type</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubernetes.io/tls</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看 pod 等待下载镜像, Running 则成功</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress-nginx</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> po</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -w</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                             READY</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   STATUS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">              RESTARTS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ingress-nginx-controller-22lhv</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   0/1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     ContainerCreating</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          23s</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ingress-nginx-controller-22lhv</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   0/1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Running</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">             0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          46s</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ingress-nginx-controller-22lhv</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   1/1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Running</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">             0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          63s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>之后 <strong>DaemonSet</strong> 会在指定的节点上起 <strong>ingress pod</strong> 并暴露 <strong>80</strong> 和 <strong>443</strong> 端口</p><h4 id="ingress-扩容缩容" tabindex="-1"><a class="header-anchor" href="#ingress-扩容缩容"><span>ingress 扩容缩容</span></a></h4><p>若需扩充 <strong>ingress pod</strong>，可直接其他节点打标签，<strong>DaemonSet</strong> 会持续监听并部署</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> label</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> node</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> k8s-slave-173</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 此时查看已扩容，正在部署</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress-nginx</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> po</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                             READY</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   STATUS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">              RESTARTS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ingress-nginx-controller-22lhv</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   1/1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Running</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">             0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          7m49s</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ingress-nginx-controller-2gvv6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   0/1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     ContainerCreating</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          16s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>外部的 <strong>WebLB</strong> 再将扩容的节点地址写入即可，缩容直接删标签即可</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> label</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> node</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> k8s-slave-173</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress-</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 此时查看已缩容，正在销毁</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress-nginx</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> po</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                             READY</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   STATUS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        RESTARTS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ingress-nginx-controller-22lhv</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   1/1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Running</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">       0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          12m</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ingress-nginx-controller-2gvv6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   1/1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Terminating</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          4m58s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>需要先将外部的 <strong>WebLB</strong> 配置的地址删除，再执行如上缩容操作，保证请求正常</p><h3 id="_2-2-ingress-使用-发布流程" tabindex="-1"><a class="header-anchor" href="#_2-2-ingress-使用-发布流程"><span>2.2 ingress 使用（发布流程）</span></a></h3><p>如上已经安装完 <strong>ingress-nginx</strong> 的 控制器了，之后可以编写 <strong>yaml</strong> 来创建 <strong>Ingress</strong> 示例</p><p>配置域名通常用 <a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/" target="_blank" rel="noopener noreferrer">Annotations</a></p><p>只需创建一次 <strong>Ingress</strong> 实例，即可自动生成 <strong>nginx</strong> 配置，</p><p>若灰度发布、跨域、限速等配置，其配置文件写于 <strong>Annotations</strong> 里面，<strong>ingress controller</strong> 会分析 <strong>ingress</strong> 实例，从 <strong>Annotations</strong> 里面读取配置（<em>具有校验功能</em> ），生成 <strong>nginx</strong> 配置文件</p><p>示例： 通过配置 <strong>ingress</strong> 域名反代到 <strong>nginx</strong> 服务上，如下创建一个名为 <strong>example</strong> 的 <strong>ingress</strong></p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">$ vim ingress.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># ingress 需要和服务在同一个 namespace 下, </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">apiVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">networking.k8s.io/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">Ingress</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  annotations</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    kubernetes.io/ingress.class</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;nginx&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">example</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">dev</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">spec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  rules</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">host</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">nginx.bar.com</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      paths</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">backend</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">          serviceName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">svc-nignx</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">          servicePort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">80</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">backend</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">          serviceName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">http-svc-abc</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">          servicePort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">80</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/abc</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>apiVersion：</strong></p><ul><li><code>networking.k8s.io/v1beta1</code> 会在 <strong>1.22</strong> 后废弃</li><li><code>networking.k8s.io/v1:</code> <strong>1.22</strong> 之后的</li><li><code>extensinos/v1beta1:</code> 最开始的版本，已废弃</li></ul><p>**annotations：**告诉接口，声明使用的 <strong>配置实例</strong> 是什么，这是由于集群中可能不止一个 <strong>ingress</strong> 控制器</p><ul><li><code>kubernetes.io/ingress.class：</code> 如上实例是 <strong>ingress-nginx</strong> （<em>在上文 <strong>value.yaml</strong> 中指定</em> ）</li></ul><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> values.yaml</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> |</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">grep</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingressClass</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#  ingressClass: nginx</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>rules：</strong> 固定写法，一个 <strong>ingress</strong> 可以配置多个 <strong>rules</strong> （<em>一个文件中可以指定多个域名</em>）</p><ul><li><code>host：</code> 配置域名，若不写则是 <strong>*</strong> 此时输入任何域名都会被解析，不推荐</li><li><code>path：</code> 相当于 <strong>nginx</strong> 的 <strong>location</strong> 配置，同一个 <strong>hosts</strong> 可以配置多个路径</li><li><code>backend:</code> 多个路径可以与不同的 <strong>Service</strong> 关联，上文表示一个域名下的两个路径，可通过 <strong>svc</strong> 访问</li></ul><p>创建 <strong>ingress</strong></p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> create</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -f</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress.yaml</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ingress.networking.k8s.io/rewrite</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> created</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看 ingress</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ing</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      HOSTS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">           ADDRESS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          PORTS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">example</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   nginx.bar.com</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   10.107.244.209</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   80</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      55s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置 <strong>hosts</strong> 解析</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>192.168.3.172 nginx.bar.com</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>若购买的域名，则解析到公司的 <strong>LB</strong> 上（<em><strong>LB</strong>是有地址的</em> ）然后 <strong>LB</strong> 再反代到 <strong>k8s</strong> 的 <strong>ingress</strong> 上，然后 <strong>ingress</strong> 再按着上面配置挨个来</p></div><h4 id="动态更新实现逻辑" tabindex="-1"><a class="header-anchor" href="#动态更新实现逻辑"><span>动态更新实现逻辑</span></a></h4><ol><li><strong>ingress controller</strong> 通过和 <strong>k8s</strong> 的 <strong>api</strong> 交互，动态感知集群中 <strong>ingress</strong> 规则变化</li><li>读取 <strong>ingress</strong> 规则（<em>哪个域名对应哪个 <strong>service</strong></em> ），按自定义的规则，生成 <strong>nginx</strong> 配置</li><li>再写到 <strong>nginx-ingress-controller</strong> 的 <strong>pod</strong> 里，其 <strong>pod</strong> 里运行着一个 <strong>Nginx</strong> 服务，控制器把生成的 <strong>nginx</strong> 配置写入 <code>/etc/nginx.conf</code> 文件中，然后 <strong>reload</strong> 一下使配置生效</li></ol><p>如下 <strong>yaml</strong> 文件</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">apiVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">extensions/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">Ingress</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">myblog</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">uit</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">spec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  rules</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">host</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">myblog.devops.cn</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    paths</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      backend</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      serviceName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">myblog</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      servicePort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">80</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ingress-nginx</strong> 会动态生成 <strong>upstream</strong> 配置</p><div class="language-ini line-numbers-mode" data-highlighter="shiki" data-ext="ini" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">server_name myblog.devops.cn </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">listen 80 </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">listen [::]:80 </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">listen 443 ssl http2 </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">listen [::]:443 ssl http2 </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">set $proxy_upstream_name </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;-&quot;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">ssl_certificate_by_lua_block {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">certificate.call()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">location / {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">set $namespace </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;demo&quot;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">set $ingress_name </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;myblog&quot;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>若需要 <strong>HTTPS</strong> 访问，需要生成证书</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 自签名证书</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> openssl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> req</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -x509</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -nodes</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -days</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2920</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -newkey</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> rsa:2048</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -keyout</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tls.key</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -out</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tls.crt</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -subj</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;/CN=*.devops.cn/O=ingress-nginx&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 证书信息保存到 secret对象中，ingress-nginx 会读取 secret 对象解析出证书加载到 nginx 配置中</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> create</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> secret</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tls</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> https-secret</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --key</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tls.key</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --cert</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tls.crt</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">secret/https-secret</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> created</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如上配置后面新增 <strong>tls</strong> 即可</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">tls</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">- </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">hosts</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">- </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">myblog.devops.cn</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">secretName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">https-secret</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><!----><!----></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">最近更新：</span><time class="vp-meta-info" datetime="2023-01-09T06:55:55.000Z" data-allow-mismatch>2023/1/9 06:55</time></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/tool/Kubernetes/k8s%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD.html" aria-label="Kubernets - 工作负载" iconsizing="both"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->Kubernets - 工作负载</div></a><a class="route-link auto-link next" href="/tool/Kubernetes/k8s%E5%AD%98%E5%82%A8.html" aria-label="Kubernets - 存储" iconsizing="both"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">Kubernets - 存储<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">默认页脚</div><div class="vp-copyright">Copyright © 2025 悦·宝宝 </div></footer></div><!--]--><!--[--><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BFWhIhUk.js" defer></script>
  </body>
</html>
