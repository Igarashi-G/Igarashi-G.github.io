import{_ as p}from"./plugin-vueexport-helper.2444895f.js";import{o,c as l,e as i,a as n,b as s,d as t,f as a,r as c}from"./app.dc8bd00f.js";const u="/assets/\u52A0\u57DF\u6D41\u7A0B.97cf7dca.png",r="/assets/\u9000\u57DF\u6D41\u7A0B.ba0c04f7.png",d={},k=n("p",null,[n("strong",null,"UFS"),s(" \u7BA1\u7406\u5E73\u53F0 \u901A\u8FC7 "),n("strong",null,"ldap3"),s(" \u7B49 "),n("strong",null,"Python"),s(" \u5DE5\u5177\uFF0C\u5BF9\u63A5\u57DF\u76F8\u5173\u7684\u8BA4\u8BC1")],-1),v=a('<h1 id="python-\u5BF9\u63A5\u57DF\u8BA4\u8BC1" tabindex="-1"><a class="header-anchor" href="#python-\u5BF9\u63A5\u57DF\u8BA4\u8BC1" aria-hidden="true">#</a> Python \u5BF9\u63A5\u57DF\u8BA4\u8BC1</h1><h2 id="_1-\u9700\u6C42\u5206\u6790" tabindex="-1"><a class="header-anchor" href="#_1-\u9700\u6C42\u5206\u6790" aria-hidden="true">#</a> 1. \u9700\u6C42\u5206\u6790</h2><blockquote><p>\u652F\u6301\u6240\u6709\u5B58\u50A8\u8282\u70B9\u52A0\u5165\u5230 <strong>AD\u57DF / LDAP</strong></p><p><strong>CIFS</strong> \u670D\u52A1\uFF08<em>NAS\u8282\u70B9</em>\uFF09\u652F\u6301 <strong>AD</strong>\u57DF | \u672C\u5730\u8BA4\u8BC1</p></blockquote><h3 id="_1-1-\u52A0\u5165-\u9000\u51FA\u57DF" tabindex="-1"><a class="header-anchor" href="#_1-1-\u52A0\u5165-\u9000\u51FA\u57DF" aria-hidden="true">#</a> 1.1 \u52A0\u5165/\u9000\u51FA\u57DF</h3><h5 id="\u52A0\u5165\u57DF\u7684\u573A\u666F" tabindex="-1"><a class="header-anchor" href="#\u52A0\u5165\u57DF\u7684\u573A\u666F" aria-hidden="true">#</a> <strong>\u52A0\u5165\u57DF\u7684\u573A\u666F</strong></h5><ul><li><strong>\u6DFB\u52A0/\u6269\u5BB9\u8282\u70B9\u540E\uFF1A</strong> \u63D0\u793A <code>&quot;\u5F53\u524D\u8282\u70B9\u5C1A\u672A\u52A0\u5165\u57DF&quot;</code> <strong>\u624B\u52A8\u6267\u884C\u5355\u8282\u70B9\u52A0\u5165\u57DF</strong></li><li><strong>\u52A0\u5165\u5931\u8D25\u65F6\uFF1A</strong> \u63D0\u793A <code>&quot;\u5F53\u524D\u8282\u70B9\u52A0\u5165\u57DF\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u73AF\u5883&quot;</code> <strong>\u624B\u52A8\u6267\u884C\u5355\u8282\u70B9\u52A0\u5165\u57DF</strong></li></ul><h5 id="\u4FEE\u6539\u57DF\u7684\u573A\u666F" tabindex="-1"><a class="header-anchor" href="#\u4FEE\u6539\u57DF\u7684\u573A\u666F" aria-hidden="true">#</a> <strong>\u4FEE\u6539\u57DF\u7684\u573A\u666F</strong></h5><ul><li>\u6682\u4E0D\u652F\u6301</li></ul><h5 id="\u9000\u51FA\u57DF\u7684\u573A\u666F" tabindex="-1"><a class="header-anchor" href="#\u9000\u51FA\u57DF\u7684\u573A\u666F" aria-hidden="true">#</a> <strong>\u9000\u51FA\u57DF\u7684\u573A\u666F</strong></h5><ul><li><strong>\u5220\u9664\u8282\u70B9\u524D\uFF1A</strong> \u5220\u9664\u8282\u70B9\u65F6\u6821\u9A8C\uFF0C\u82E5\u8BE5\u8282\u70B9\u4F9D\u7136\u5728\u57DF\u4E2D\uFF0C\u63D0\u793A &quot;<code>\u8BF7\u5148\u9000\u51FAAD/LDAP\u57DF\uFF0C\u518D\u91CD\u8BD5\u5220\u9664</code>&quot; <ul><li>\u662F\u5426\u652F\u6301\u5F3A\u5236\u9000\u51FA\u57DF\uFF1F \u3010\u652F\u6301/\u4E0D\u652F\u6301\u3011</li></ul></li></ul><h3 id="_1-2-ad-ldap\u7684\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#_1-2-ad-ldap\u7684\u914D\u7F6E" aria-hidden="true">#</a> 1.2 AD/LDAP\u7684\u914D\u7F6E</h3><h5 id="ad\u57DF\u914D\u7F6E\u53C2\u6570" tabindex="-1"><a class="header-anchor" href="#ad\u57DF\u914D\u7F6E\u53C2\u6570" aria-hidden="true">#</a> <strong>AD\u57DF\u914D\u7F6E\u53C2\u6570</strong></h5><ul><li><strong>AD\u57DF\u540D\uFF1A</strong> \u5982 <code>uit.devops.local</code></li><li><strong>AD DNS IP\uFF1A</strong> \u5982 <code>172.16.70.124</code></li><li><strong>\u7BA1\u7406\u5458\u8D26\u53F7</strong></li><li><strong>\u7BA1\u7406\u5458\u5BC6\u7801\uFF1A</strong><ul><li>\u8003\u8651\u52A0\u5BC6</li></ul></li><li>\u3010\u5F85\u5B9A\u3011<strong>\u8FC7\u6EE4\u5668\uFF1A</strong> \u4F8B\u5982 OU\u3001CN \u7B49\u6216\u81EA\u5B9A\u4E49\u7684\u7ED3\u6784\uFF0C\u6682\u4E0D\u8003\u8651\uFF0C\u76F4\u63A5\u83B7\u53D6\u6240\u6709\u6570\u636E</li><li>\u3010\u5F85\u5B9A\u3011<strong>\u8BA4\u8BC1\u65B9\u5F0F\u9009\u62E9\uFF1A</strong> \u5F53\u524D\u57FA\u4E8E <strong>kerberos</strong> \u7684 <code>GSS-API SASL</code> \u8BA4\u8BC1 <ul><li>\u5176\u4ED6\u65B9\u5F0F\u8FD8\u6709 <strong>Simple authentication</strong> \u7684 <code>SSL/TLS</code> \u8BA4\u8BC1</li></ul></li><li>\u3010\u9ED8\u8BA4\u5185\u7F6E\u3011<strong>version\uFF1A</strong> \u4EC5\u652F\u6301 <strong>v3</strong></li><li><strong>\u6D4B\u8BD5\u6309\u94AE\uFF1A</strong> \u6D4B\u8BD5\u5F53\u524D <strong>AD</strong> \u57DF\u662F\u5426\u8FDE\u901A\uFF0C\u672A\u6D4B\u8BD5\u901A\u8FC7\u524D\u65E0\u6CD5\u6267\u884C <strong>\u201C\u52A0\u5165\u57DF\u201D</strong> \u64CD\u4F5C <ul><li><strong>\u6210\u529F\uFF1A</strong> \u63D0\u793A &quot;<code>\u8FDE\u63A5\u6210\u529F</code>&quot;</li><li><strong>\u5931\u8D25\uFF1A</strong><ul><li><strong>\u8D85\u65F6 10s \u540E\uFF1A</strong> \u63D0\u793A &quot;<code>\u670D\u52A1\u5668\u4E0D\u5728\u5DE5\u4F5C</code>&quot;</li><li><strong>\u76F8\u540C hostname\uFF1A</strong> \u63D0\u793A &quot;<code>\u5B58\u5728\u76F8\u540C\u4E3B\u673A\u540D\uFF0C\u65E0\u6CD5\u52A0\u5165</code>&quot;</li></ul></li></ul></li></ul><h5 id="ldap\u914D\u7F6E\u53C2\u6570" tabindex="-1"><a class="header-anchor" href="#ldap\u914D\u7F6E\u53C2\u6570" aria-hidden="true">#</a> <strong>LDAP\u914D\u7F6E\u53C2\u6570</strong></h5><ul><li><p><strong>LDAP\u57FA\u51C6DN\uFF1A</strong> \u5982 <code>DC=uit,DC=ldevops,DC=local</code></p></li><li><p><strong>LDAP\u4E3B\u670D\u52A1\u5668IP\uFF1A</strong> \u5982 <code>172.16.70.124</code></p><ul><li>\u3010\u5F85\u5B9A\u3011<strong>LDAP\u4ECE\u670D\u52A1\u5668IP\uFF1A</strong></li></ul></li><li><p><strong>LDAP \u7AEF\u53E3\uFF1A</strong> \u9ED8\u8BA4 <code>389</code></p></li><li><p>\u3010\u5F85\u5B9A\u3011<strong>LDAP\u534F\u8BAE\uFF1A</strong> <code>LDAP/LDAPS</code></p></li><li><p><strong>\u7BA1\u7406\u5458\u8D26\u53F7</strong></p></li><li><p><strong>\u7BA1\u7406\u5458\u5BC6\u7801</strong></p></li><li><p><strong>\u6D4B\u8BD5\u6309\u94AE\uFF1A</strong> \u540C\u4E0A</p></li><li><p><strong>\u9AD8\u7EA7\u53C2\u6570\uFF1A</strong> \u5BF9\u8C61 <code>Objectclass=*</code></p></li></ul><h3 id="_1-3-\u96C6\u6210\u5230cifs\u3001\u6587\u4EF6\u8BBE\u7F6E\u3001posix" tabindex="-1"><a class="header-anchor" href="#_1-3-\u96C6\u6210\u5230cifs\u3001\u6587\u4EF6\u8BBE\u7F6E\u3001posix" aria-hidden="true">#</a> 1.3 \u96C6\u6210\u5230CIFS\u3001\u6587\u4EF6\u8BBE\u7F6E\u3001POSIX</h3><p><strong>\u8BA4\u8BC1\u6A21\u5F0F\uFF1A</strong> \u652F\u6301 <strong>\u672C\u5730\u8BA4\u8BC1</strong> \u6216\u8005 <strong>\u57DF\u8BA4\u8BC1</strong> \uFF08<em>\u9700\u8981\u589E\u52A0\u5168\u5C40\u914D\u7F6E\u6587\u4EF6</em>\uFF09</p><ul><li><strong>Samba\u5171\u4EAB\u5BFC\u51FA\uFF1A</strong> \u589E\u52A0\u6307\u5B9A\u8BA4\u8BC1\u6A21\u5F0F</li><li><strong>\u6587\u4EF6\u9AD8\u7EA7\u8BBE\u7F6E\uFF1A</strong> \u540C\u4E0A</li><li><strong>POSIX\u5171\u4EAB\uFF1A</strong> \u540C\u4E0A</li></ul>',18),m={href:"https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/system_administrators_guide/ch-file_and_print_servers#understanding_id_mapping",target:"_blank",rel:"noopener noreferrer"},b=a('<h2 id="_2-\u52A0\u57DF\u3001\u9000\u57DF\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_2-\u52A0\u57DF\u3001\u9000\u57DF\u5B9E\u73B0" aria-hidden="true">#</a> 2. \u52A0\u57DF\u3001\u9000\u57DF\u5B9E\u73B0</h2><h3 id="_2-1-\u52A0\u57DF\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#_2-1-\u52A0\u57DF\u6D41\u7A0B" aria-hidden="true">#</a> 2.1 \u52A0\u57DF\u6D41\u7A0B</h3><img src="'+u+`"><h4 id="ad\u57DF\u52A0\u5165\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#ad\u57DF\u52A0\u5165\u6D41\u7A0B" aria-hidden="true">#</a> AD\u57DF\u52A0\u5165\u6D41\u7A0B</h4><p>\u7B80\u5355\u8BA4\u8BC1 <strong>winbind + kerberos</strong> \uFF0C\u9700\u5B89\u88C5\u5982\u4E0B\u8F6F\u4EF6</p><ul><li><strong>winbind \uFF1A</strong> \u5141\u8BB8 <strong>Unix</strong> \u7CFB\u7EDF\u5229\u7528 <strong>Windows NT</strong> \u7684\u7528\u6237\u5E10\u53F7\u4FE1\u606F\u6765\u89E3\u6790 <strong>AD</strong> \u57DF \u7684\u7A0B\u5E8F</li><li><strong>kerberos\uFF1A</strong> \u52A0\u5BC6 <strong>Ticket</strong> \u7684\u7F51\u7EDC\u8EAB\u4EFD\u8BA4\u8BC1\u534F\u8BAE\uFF0C\u7531 <strong>Key Distribution Center</strong> (<em>\u5373KDC)</em>\u3001<strong>Client</strong> \u548C <strong>Service</strong> \u7EC4\u6210\uFF0C\u8BBF\u95EE<strong>KDC</strong> \u4E24\u6B21\uFF0C\u62FF\u5230 <strong>TGT</strong>\uFF0C\u518D\u8BBF\u95EE\u670D\u52A1\u5668</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ yum <span class="token function">install</span> realmd oddjob-mkhomedir oddjob samba-winbind-clients samba-winbind samba-common-tools samba-winbind-krb5-locator krb5-devel krb5-workstation <span class="token parameter variable">-y</span>

<span class="token comment"># \u5B89\u88C5\u540E\uFF0C\u5BA2\u6237\u7AEF\u4F1A\u751F\u6210 Kerberos \u7684\u914D\u7F6E\u6587\u4EF6</span>
<span class="token string">&quot;/etc/krb5.conf&quot;</span>

<span class="token comment"># \u68C0\u67E5</span>
$ systemctl status winbind
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4EE5\u57DF <strong>UIT.DEVOPS.LOCAL</strong> \uFF08<em>172.16.70.104</em>\uFF09\u793A\u4F8B\uFF1A</p><p>\u4F7F\u7528 <strong>Jinjia</strong> \u6A21\u677F</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> jinja2 <span class="token keyword">import</span> Environment<span class="token punctuation">,</span> FileSystemLoader<span class="token punctuation">,</span> Template
<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path


<span class="token keyword">class</span> <span class="token class-name">JinJaConfig</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>env_path <span class="token operator">=</span> Path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>parent<span class="token punctuation">,</span> <span class="token string">&quot;etc&quot;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_config_file <span class="token operator">=</span> path
        self<span class="token punctuation">.</span>template <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
        self<span class="token punctuation">.</span>_parse_data<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_parse_data</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        env <span class="token operator">=</span> Environment<span class="token punctuation">(</span>loader<span class="token operator">=</span>FileSystemLoader<span class="token punctuation">(</span>self<span class="token punctuation">.</span>env_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>template <span class="token operator">=</span> env<span class="token punctuation">.</span>get_template<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_config_file<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">reload</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_parse_data<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">render_str</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>template<span class="token punctuation">,</span> Template<span class="token punctuation">)</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> self<span class="token punctuation">.</span>template<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> data

    
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">render_action</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    conf <span class="token operator">=</span> jinja_config<span class="token punctuation">.</span>JinJaConfig<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    render_data <span class="token operator">=</span> conf<span class="token punctuation">.</span>render_str<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_data


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">gen_krb5_config</span><span class="token punctuation">(</span>
        realm<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        server_ip<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    upper_realm <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>realm<span class="token punctuation">)</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>

    path <span class="token operator">=</span> <span class="token string">&quot;krb5/krb5.cfg&quot;</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;realm&quot;</span><span class="token punctuation">:</span> realm<span class="token punctuation">,</span>
        <span class="token string">&quot;server_ip&quot;</span><span class="token punctuation">:</span> server_ip<span class="token punctuation">,</span>
        <span class="token string">&quot;upper_realm&quot;</span><span class="token punctuation">:</span> upper_realm<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> render_action<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">**</span>data<span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">gen_local_smb_config</span><span class="token punctuation">(</span>
        smb_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        smb_shares_file<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    path <span class="token operator">=</span> <span class="token string">&quot;smb/smb.cfg&quot;</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;smb_shares_file&quot;</span><span class="token punctuation">:</span> smb_shares_file<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    smb_local_share <span class="token operator">=</span> <span class="token keyword">await</span> render_action<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">**</span>data<span class="token punctuation">)</span>

    <span class="token keyword">await</span> write_action<span class="token punctuation">(</span>smb_path<span class="token punctuation">,</span> smb_local_share<span class="token punctuation">)</span>
    <span class="token keyword">await</span> aiofiles<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>smb_shares_file<span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">gen_ad_smb_config</span><span class="token punctuation">(</span>
        host_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        realm<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        server_ip<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        workgroup<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        id_map_range<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        id_map_ad_range<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        smb_shares_file<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    upper_realm <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>realm<span class="token punctuation">)</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># FIXME: smb_domain.cfg \u4E2D\uFF0C\u5C06 security = domain \u6682\u65F6\u66FF\u6362\u4E3A ads</span>
    path <span class="token operator">=</span> <span class="token string">&quot;smb/smb_ad.cfg&quot;</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;host_name&quot;</span><span class="token punctuation">:</span> host_name<span class="token punctuation">,</span>
        <span class="token string">&quot;realm&quot;</span><span class="token punctuation">:</span> realm<span class="token punctuation">,</span>
        <span class="token string">&quot;server_ip&quot;</span><span class="token punctuation">:</span> server_ip<span class="token punctuation">,</span>
        <span class="token string">&quot;workgroup&quot;</span><span class="token punctuation">:</span> workgroup<span class="token punctuation">,</span>
        <span class="token string">&quot;id_map_range&quot;</span><span class="token punctuation">:</span> id_map_range<span class="token punctuation">,</span>
        <span class="token string">&quot;id_map_ad_range&quot;</span><span class="token punctuation">:</span> id_map_ad_range<span class="token punctuation">,</span>
        <span class="token string">&quot;upper_realm&quot;</span><span class="token punctuation">:</span> upper_realm<span class="token punctuation">,</span>
        <span class="token string">&quot;smb_shares_file&quot;</span><span class="token punctuation">:</span> smb_shares_file<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> render_action<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">**</span>data<span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">gen_ldap_smb_config</span><span class="token punctuation">(</span>
        host_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        server_ip<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        workgroup<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        base_dn<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        bind_dn<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        smb_shares_file<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    path <span class="token operator">=</span> <span class="token string">&quot;smb/smb_ldap.cfg&quot;</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;host_name&quot;</span><span class="token punctuation">:</span> host_name<span class="token punctuation">,</span>
        <span class="token string">&quot;server_ip&quot;</span><span class="token punctuation">:</span> server_ip<span class="token punctuation">,</span>
        <span class="token string">&quot;workgroup&quot;</span><span class="token punctuation">:</span> workgroup<span class="token punctuation">,</span>
        <span class="token string">&quot;base_dn&quot;</span><span class="token punctuation">:</span> base_dn<span class="token punctuation">,</span>
        <span class="token string">&quot;bind_dn&quot;</span><span class="token punctuation">:</span> bind_dn<span class="token punctuation">,</span>
        <span class="token string">&quot;smb_shares_file&quot;</span><span class="token punctuation">:</span> smb_shares_file<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> render_action<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">**</span>data<span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">gen_ad_nsswitch_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    path <span class="token operator">=</span> <span class="token string">&quot;nsswitch/nsswitch_ad.cfg&quot;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> render_action<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">**</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">gen_ldap_nsswitch_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    path <span class="token operator">=</span> <span class="token string">&quot;nsswitch/nsswitch_ldap.cfg&quot;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> render_action<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">**</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">gen_ldap_nslcd_config</span><span class="token punctuation">(</span>
        server_ip<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        base_dn<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        bind_dn<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        admin_pwd<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        userObjclass<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        groupObjclass<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    path <span class="token operator">=</span> <span class="token string">&quot;nslcd/nslcd.cfg&quot;</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;server_ip&quot;</span><span class="token punctuation">:</span> server_ip<span class="token punctuation">,</span>
        <span class="token string">&quot;base_dn&quot;</span><span class="token punctuation">:</span> base_dn<span class="token punctuation">,</span>
        <span class="token string">&quot;bind_dn&quot;</span><span class="token punctuation">:</span> bind_dn<span class="token punctuation">,</span>
        <span class="token string">&quot;admin_pwd&quot;</span><span class="token punctuation">:</span> admin_pwd<span class="token punctuation">,</span>
        <span class="token string">&quot;userObjclass&quot;</span><span class="token punctuation">:</span> userObjclass<span class="token punctuation">,</span>
        <span class="token string">&quot;groupObjclass&quot;</span><span class="token punctuation">:</span> groupObjclass<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> render_action<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">**</span>data<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5907\u4EFD\u5E76\u4FEE\u6539 <code>/etc/krb5.conf</code> \u914D\u7F6E\u6587\u4EF6\u4E3A\u5982\u4E0B</p><div class="language-ini ext-ini line-numbers-mode"><pre class="language-ini"><code><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">logging</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">default</span> <span class="token punctuation">=</span> <span class="token value attr-value">FILE:/var/log/krb5libs.log</span>
<span class="token key attr-name">kdc</span> <span class="token punctuation">=</span> <span class="token value attr-value">FILE:/var/log/krb5kdc.log</span>
<span class="token key attr-name">admin_server</span> <span class="token punctuation">=</span> <span class="token value attr-value">FILE:/var/log/kadmind.log</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">libdefaults</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">default_realm</span> <span class="token punctuation">=</span> <span class="token value attr-value">{{upper_realm}}</span>
<span class="token key attr-name">dns_lookup_realm</span> <span class="token punctuation">=</span> <span class="token value attr-value">false</span>
<span class="token key attr-name">dns_lookup_kdc</span> <span class="token punctuation">=</span> <span class="token value attr-value">false</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">realms</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">{{upper_realm}}</span> <span class="token punctuation">=</span> <span class="token value attr-value">{</span>
    <span class="token key attr-name">kdc</span> <span class="token punctuation">=</span> <span class="token value attr-value">{{server_ip}}</span>
    <span class="token key attr-name">default_ad</span> <span class="token punctuation">=</span> <span class="token value attr-value">{{upper_realm}}</span>
}

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">ad_realm</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">.{{upper_realm}}</span> <span class="token punctuation">=</span> <span class="token value attr-value">{{upper_realm}}</span>
<span class="token key attr-name">{{upper_realm}}</span> <span class="token punctuation">=</span> <span class="token value attr-value">{{upper_realm}}</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">kdc</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">profile</span> <span class="token punctuation">=</span> <span class="token value attr-value">/var/kerberos/krb5kdc/kdc.conf</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">appdefaults</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">pam</span> <span class="token punctuation">=</span> <span class="token value attr-value">{</span>
    <span class="token key attr-name">debug</span> <span class="token punctuation">=</span> <span class="token value attr-value">false</span>
    <span class="token key attr-name">ticket_lifetime</span> <span class="token punctuation">=</span> <span class="token value attr-value">36000</span>
    <span class="token key attr-name">renew_lifetime</span> <span class="token punctuation">=</span> <span class="token value attr-value">36000</span>
    <span class="token key attr-name">forwardable</span> <span class="token punctuation">=</span> <span class="token value attr-value">true</span>
    <span class="token key attr-name">krb4_convert</span> <span class="token punctuation">=</span> <span class="token value attr-value">false</span>
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>[logging]\uFF1A</strong> \u8868\u793A <strong>Server</strong> \u7AEF\u7684\u65E5\u5FD7\u7684\u6253\u5370\u4F4D\u7F6E</li><li><strong>[libdefaults]\uFF1A</strong> \u8FDE\u63A5\u9ED8\u8BA4\u914D\u7F6E <ul><li><code>default_realm = UIT.DEVOPS.LOCAL</code> \u5927\u5199\uFF0C\u4E0E\u4E0B\u6587 <strong>realms</strong> \u7684\u4E00\u81F4</li></ul></li><li><strong>[realms]\uFF1A</strong> \u5217\u4E3E\u4F7F\u7528\u7684 <strong>realm</strong></li><li><code>kdc</code> \u673A\u5668\u7684 <strong>hostname</strong> \u6216 <strong>IP</strong> \u5730\u5740</li><li><code>admin_server</code> \u673A\u5668\u7684 <strong>hostname</strong> \u6216 <strong>IP</strong> \u5730\u5740</li><li><code>default_domain</code> \u9ED8\u8BA4\u7684\u57DF\u540D</li><li><strong>[appdefaults]\uFF1A</strong> \u8BBE\u5B9A\u4E00\u4E9B\u9488\u5BF9\u7279\u5B9A\u5E94\u7528\u7684\u914D\u7F6E\uFF0C\u8986\u76D6\u9ED8\u8BA4\u914D\u7F6E</li></ul><p>\u5907\u4EFD\u5E76\u4FEE\u6539 <code>/etc/hosts</code> \u6587\u4EF6\uFF0C\u52A0\u5165</p><div class="language-ini ext-ini line-numbers-mode"><pre class="language-ini"><code>172.16.70.124	server124.uit.devops.local
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u5907\u4EFD\u5E76\u4FEE\u6539 <code>/etc/samba/smb.conf</code> \u5982\u4E0B</p><div class="language-ini ext-ini line-numbers-mode"><pre class="language-ini"><code><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">global</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">workgroup</span> <span class="token punctuation">=</span> <span class="token value attr-value">{{workgroup}}</span>
<span class="token key attr-name">netbios name</span> <span class="token punctuation">=</span> <span class="token value attr-value">{{host_name}}</span>
<span class="token key attr-name">server string</span> <span class="token punctuation">=</span>
<span class="token key attr-name">security</span> <span class="token punctuation">=</span> <span class="token value attr-value">ads</span>
<span class="token key attr-name">realm</span> <span class="token punctuation">=</span> <span class="token value attr-value">{{upper_realm}}</span>
<span class="token key attr-name">password server</span> <span class="token punctuation">=</span> <span class="token value attr-value">{{upper_realm}}</span>
<span class="token key attr-name">encrypt passwords</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">local master</span> <span class="token punctuation">=</span> <span class="token value attr-value">no</span>
<span class="token key attr-name">domain master</span> <span class="token punctuation">=</span> <span class="token value attr-value">no</span>
<span class="token key attr-name">preferred master</span> <span class="token punctuation">=</span> <span class="token value attr-value">no</span>
<span class="token key attr-name">idmap config * : backend</span> <span class="token punctuation">=</span> <span class="token value attr-value">tdb</span>
<span class="token key attr-name">idmap config * : range</span> <span class="token punctuation">=</span> <span class="token value attr-value">{{id_map_range}}</span>
<span class="token key attr-name">idmap config {{workgroup}} : backend</span> <span class="token punctuation">=</span> <span class="token value attr-value">rid</span>
<span class="token key attr-name">idmap config {{workgroup}} : range</span> <span class="token punctuation">=</span> <span class="token value attr-value">{{id_map_ad_range}}</span>
<span class="token key attr-name">winbind use default domain</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">winbind enum users</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">winbind enum groups</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">winbind separator</span> <span class="token punctuation">=</span> <span class="token value attr-value">+</span>

<span class="token comment"># optimization</span>
<span class="token key attr-name">sync always</span> <span class="token punctuation">=</span> <span class="token value attr-value">no</span>
<span class="token key attr-name">write cache size</span> <span class="token punctuation">=</span> <span class="token value attr-value">10485760</span>
<span class="token key attr-name">socket options</span> <span class="token punctuation">=</span> <span class="token value attr-value">TCP_NODELAY IPTOS_LOWDELAY SO_RCVBUF=131072 SO_SNDBUF=131072</span>
<span class="token key attr-name">use sendfile</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">min receivefile size</span> <span class="token punctuation">=</span> <span class="token value attr-value">131072</span>

<span class="token comment"># ad common params</span>
<span class="token key attr-name">log file</span> <span class="token punctuation">=</span> <span class="token value attr-value">/var/log/samba/%m.log</span>
<span class="token key attr-name">max log size</span> <span class="token punctuation">=</span> <span class="token value attr-value">50</span>
<span class="token key attr-name">printcap name</span> <span class="token punctuation">=</span> <span class="token value attr-value">/etc/printcap</span>
<span class="token key attr-name">load printers</span> <span class="token punctuation">=</span> <span class="token value attr-value">no</span>
<span class="token key attr-name">wins server</span> <span class="token punctuation">=</span>
<span class="token key attr-name">unix charset</span> <span class="token punctuation">=</span> <span class="token value attr-value">utf-8</span>
<span class="token key attr-name">dos charset</span> <span class="token punctuation">=</span> <span class="token value attr-value">cp936</span>
<span class="token key attr-name">dns proxy</span> <span class="token punctuation">=</span> <span class="token value attr-value">no</span>
<span class="token key attr-name">delete readonly</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">create mask</span> <span class="token punctuation">=</span> <span class="token value attr-value">0777</span>
<span class="token key attr-name">directory mask</span> <span class="token punctuation">=</span> <span class="token value attr-value">0777</span>
<span class="token key attr-name">force create mode</span> <span class="token punctuation">=</span> <span class="token value attr-value">0777</span>
<span class="token key attr-name">force directory mode</span> <span class="token punctuation">=</span> <span class="token value attr-value">0777</span>
<span class="token key attr-name">template shell</span> <span class="token punctuation">=</span> <span class="token value attr-value">/bin/false</span>
<span class="token key attr-name">map to guest</span> <span class="token punctuation">=</span> <span class="token value attr-value">bad user</span>
<span class="token key attr-name">null passwords</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">usershare allow guests</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">include</span> <span class="token punctuation">=</span> <span class="token value attr-value">{{smb_shares_file}}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5907\u4EFD\u5E76\u4FEE\u6539 <code>/etc/nsswitch.conf</code> \u5982\u4E0B</p><div class="language-ini ext-ini line-numbers-mode"><pre class="language-ini"><code>passwd:        files winbind
shadow:        files winbind
group:         files winbind
hosts:         files dns winbind
bootparams:    files
ethers:        files
networks:      files
protocols:     files
rpc:           files
services:      files
netgroup:      files
publickey:     files
automount:     files
aliases:       files
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6267\u884C\u52A0\u57DF\u547D\u4EE4</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ net ads <span class="token function">join</span> <span class="token parameter variable">-U</span> administrator%user@dev <span class="token parameter variable">-S</span> server124.uit.devops.local
$ net ads testjoin

<span class="token comment"># \u91CD\u542F\u76F8\u5173\u670D\u52A1</span>
systemctl <span class="token builtin class-name">enable</span> winbind
systemctl restart winbind
systemctl restart nmb
systemctl restart smb

<span class="token comment"># \u6B64\u65F6\u901A\u8FC7\u5224\u65AD uid &gt; 100000 \u83B7\u53D6\u5230\u5BF9\u5E94 \u57DF\u7528\u6237 / \u7EC4 </span>
getent <span class="token function">passwd</span>

<span class="token comment"># \u7C7B\u4F3C\u5982\u4E0B</span>
local_zz:x:1000:0::/home/local_zz:/usr/sbin/nologin
xingang:x:1001:1001::/home/xingang:/bin/bash
administrator:*:10000500:10000513::/home/UIT/administrator:/bin/false
guest:*:10000501:10000513::/home/UIT/guest:/bin/false
zhengze:*:10001002:10000513::/home/UIT/zhengze:/bin/false
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">\u63D0\u793A</p><p><strong>Python</strong> \u901A\u8FC7\u5F15\u5165 <strong>pwd</strong> \u3001 <strong>grp</strong> \u5E93\uFF0C\u76F4\u63A5\u672C\u5730\u83B7\u53D6\uFF0C\u6548\u7387\u6BD4 <strong>ldap3</strong> \u9AD8\uFF0C\u4F46\u4F1A\u6709\u7F13\u5B58\uFF0C\u91CD\u542F\u670D\u52A1\u6216\u6539 <strong>C</strong> \u6E90\u7801\uFF0C\u6216\u76F4\u63A5\u8C03\u7528\u547D\u4EE4\u884C\u89E3\u6790</p></div><h4 id="ldap\u52A0\u5165\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#ldap\u52A0\u5165\u6D41\u7A0B" aria-hidden="true">#</a> LDAP\u52A0\u5165\u6D41\u7A0B</h4><p>\u4F7F\u7528 <strong>nslcd</strong> \u8FDB\u884C\u8BA4\u8BC1 \uFF0C\u4E0E <strong>AD</strong> \u57DF\u5927\u81F4\u6D41\u7A0B\u5DEE\u4E0D\u591A\uFF0C\u4E0D\u9700\u8981\u547D\u4EE4\uFF0C\u76F4\u63A5\u6539\u914D\u7F6E\u6587\u4EF6\u542F\u52A8\u5373\u53EF</p><ul><li><strong>nslcd\uFF1A</strong> \u52A0\u5165 <strong>LDAP</strong> \u7684\u7A0B\u5E8F</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u5B89\u88C5\u52A0\u5165 ldap \u6240\u9700\u5DE5\u5177</span>
$ yum <span class="token parameter variable">-y</span> <span class="token function">install</span> nss-pam-ldapd pam_ldap openldap-clients oddjob oddjob-mkhomedir
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5907\u4EFD\u5E76\u4FEE\u6539 <code>/etc/nslcd.conf</code> \u5982\u4E0B</p><div class="language-ini ext-ini line-numbers-mode"><pre class="language-ini"><code>uid nslcd
gid ldap
uri ldap://{{server_ip}}/
base {{base_dn}}
ssl no
binddn {{bind_dn}}
bindpw {{admin_pwd}}
filter passwd {{userObjclass}}
filter shadow {{userObjclass}}
filter group  {{groupObjclass}}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u9700\u8981\u4FEE\u6539\u8BE5\u914D\u7F6E\u6587\u4EF6\u6743\u9650\uFF0C\u5426\u5219\u65E0\u6CD5\u542F\u52A8\u670D\u52A1</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">chmod</span> <span class="token number">600</span> /etc/nslcd.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u5907\u4EFD\u5E76\u4FEE\u6539 <code>/etc/hosts</code> \u6587\u4EF6\uFF0C\u52A0\u5165</p><div class="language-ini ext-ini line-numbers-mode"><pre class="language-ini"><code>172.16.120.145	uit.ldevops.local
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u5907\u4EFD\u5E76\u4FEE\u6539 <code>/etc/samba/smb.conf</code> \u5982\u4E0B</p><div class="language-ini ext-ini line-numbers-mode"><pre class="language-ini"><code><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">global</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">workgroup</span> <span class="token punctuation">=</span> <span class="token value attr-value">{{workgroup}}</span>
<span class="token key attr-name">netbios name</span> <span class="token punctuation">=</span> <span class="token value attr-value">{{host_name}}</span>
<span class="token key attr-name">security</span> <span class="token punctuation">=</span> <span class="token value attr-value">user</span>
<span class="token key attr-name">passdb backend</span> <span class="token punctuation">=</span> <span class="token value attr-value">ldapsam:ldap://{{server_ip}}</span>
<span class="token key attr-name">ldap suffix</span> <span class="token punctuation">=</span> <span class="token value attr-value">&quot;<span class="token inner-value">{{base_dn}}</span>&quot;</span>
<span class="token key attr-name">ldap group suffix</span> <span class="token punctuation">=</span> <span class="token value attr-value">&quot;<span class="token inner-value">cn=group</span>&quot;</span>
<span class="token key attr-name">ldap user suffix</span> <span class="token punctuation">=</span> <span class="token value attr-value">&quot;<span class="token inner-value">ou=people</span>&quot;</span>
<span class="token key attr-name">ldap admin dn</span> <span class="token punctuation">=</span> <span class="token value attr-value">&quot;<span class="token inner-value">{{bind_dn}}</span>&quot;</span>
<span class="token key attr-name">ldap delete dn</span> <span class="token punctuation">=</span> <span class="token value attr-value">no</span>
<span class="token key attr-name">pam password change</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">ldap passwd sync</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">ldap ssl</span> <span class="token punctuation">=</span> <span class="token value attr-value">no</span>

<span class="token comment"># optimization</span>
<span class="token key attr-name">sync always</span> <span class="token punctuation">=</span> <span class="token value attr-value">no</span>
<span class="token key attr-name">write cache size</span> <span class="token punctuation">=</span> <span class="token value attr-value">10485760</span>
<span class="token key attr-name">socket options</span> <span class="token punctuation">=</span> <span class="token value attr-value">TCP_NODELAY IPTOS_LOWDELAY SO_RCVBUF=131072 SO_SNDBUF=131072</span>
<span class="token key attr-name">use sendfile</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">min receivefile size</span> <span class="token punctuation">=</span> <span class="token value attr-value">131072</span>

<span class="token comment"># ldap common params</span>
<span class="token key attr-name">log file</span> <span class="token punctuation">=</span> <span class="token value attr-value">/var/log/samba/%m.log</span>
<span class="token key attr-name">max log size</span> <span class="token punctuation">=</span> <span class="token value attr-value">50</span>
<span class="token key attr-name">printcap name</span> <span class="token punctuation">=</span> <span class="token value attr-value">/etc/printcap</span>
<span class="token key attr-name">load printers</span> <span class="token punctuation">=</span> <span class="token value attr-value">no</span>
<span class="token key attr-name">wins server</span> <span class="token punctuation">=</span>
<span class="token key attr-name">unix charset</span> <span class="token punctuation">=</span> <span class="token value attr-value">utf-8</span>
<span class="token key attr-name">dos charset</span> <span class="token punctuation">=</span> <span class="token value attr-value">cp936</span>
<span class="token key attr-name">dns proxy</span> <span class="token punctuation">=</span> <span class="token value attr-value">no</span>
<span class="token key attr-name">delete readonly</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">create mask</span> <span class="token punctuation">=</span> <span class="token value attr-value">0777</span>
<span class="token key attr-name">directory mask</span> <span class="token punctuation">=</span> <span class="token value attr-value">0777</span>
<span class="token key attr-name">force create mode</span> <span class="token punctuation">=</span> <span class="token value attr-value">0777</span>
<span class="token key attr-name">force directory mode</span> <span class="token punctuation">=</span> <span class="token value attr-value">0777</span>
<span class="token key attr-name">template shell</span> <span class="token punctuation">=</span> <span class="token value attr-value">/bin/false</span>
<span class="token key attr-name">map to guest</span> <span class="token punctuation">=</span> <span class="token value attr-value">bad user</span>
<span class="token key attr-name">null passwords</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">usershare allow guests</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">include</span> <span class="token punctuation">=</span> <span class="token value attr-value">{{smb_shares_file}}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5907\u4EFD\u5E76\u4FEE\u6539 <code>/etc/nsswitch.conf</code> \u5982\u4E0B</p><div class="language-ini ext-ini line-numbers-mode"><pre class="language-ini"><code>passwd:        files ldap
shadow:        files ldap
group:         files ldap
hosts:         files dns ldap
bootparams:    files
ethers:        files
networks:      files
protocols:     files
rpc:           files
services:      files
netgroup:      files
publickey:     files
automount:     files
aliases:       files
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6267\u884C\u52A0\u57DF\u547D\u4EE4</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u91CD\u542F\u76F8\u5173\u670D\u52A1\uFF0C\u6B63\u5E38\u542F\u52A8\u5373\u53EF</span>
systemctl restart nmb
systemctl <span class="token builtin class-name">enable</span> nslcd
systemctl restart nslcd
systemctl restart smb

<span class="token comment"># \u4E0E AD \u57DF\u4E0D\u540C\uFF0C\u6CA1\u6709\u6620\u5C04ID\uFF0C\u6B64\u65F6\u83B7\u53D6\u7684\u7528\u6237\u3001\u7EC4\u5B58\u5728 uid\u3001gid \u51B2\u7A81</span>
getent <span class="token function">passwd</span>

<span class="token comment"># \u7C7B\u4F3C\u5982\u4E0B\uFF0C\u4E14\u6709\u4E9B\u975E\u80FD\u52A0\u57DF\u7684\u7528\u6237</span>
ldapuser1:x:1002:1002:ldapuser1:/home/ldapuser1:/bin/bash
ldapuser2:x:1003:1003:ldapuser2:/home/ldapuser2:/bin/bash
root:x:0:0:Netbios Domain Administrator:/home/root:/bin/false
nobody:x:999:514:nobody:/nonexistent:/bin/false
User1:x:1005:513:System User:/home/User1:/bin/bash
igarashi:x:1000001:513:System User:/home/igarashi:/bin/bash
jackson:x:150001:513:System User:/home/jackson:/bin/bash
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container warning"><p class="custom-container-title">\u6CE8\u610F</p><p>\u901A\u5E38\u9700\u542B\u6709 <code>(objectclass=sambaSamAccount)</code> \u3001<code>(objectclass=sambaGroupMapping)</code> \u7B49\u4E00\u7CFB\u5217 <strong>samba</strong> \u76F8\u5173\u7684\u7C7B\uFF0C\u624D\u5177\u6709\u8BBF\u95EE <strong>CIFS</strong> \u7684\u80FD\u529B\uFF0C\u5EFA\u8BAE\u4F7F\u7528 <strong>sabldap</strong> \u5DE5\u5177\uFF08<em>\u8BE6\u89C1 LDAP</em> \uFF09\u6765\u6DFB\u52A0\u7528\u6237\uFF0C\u793A\u4F8B\u5982\u4E0B</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>smbldap-useradd <span class="token parameter variable">-a</span> <span class="token parameter variable">-m</span> jackson <span class="token parameter variable">-u</span> <span class="token number">150000</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></div><h3 id="_2-2-\u9000\u57DF\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#_2-2-\u9000\u57DF\u6D41\u7A0B" aria-hidden="true">#</a> 2.2 \u9000\u57DF\u6D41\u7A0B</h3><img src="`+r+`"><p>\u79BB\u5F00 <strong>AD</strong> \u57DF\uFF0C\u6267\u884C\u5982\u4E0B\u547D\u4EE4\uFF0C<strong>LDAP</strong> \u53EA\u9700\u8FD8\u539F\u914D\u7F6E\u6587\u4EF6\u91CD\u542F\u5373\u53EF</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ net ads leave <span class="token parameter variable">-U</span> administrator%\u7BA1\u7406\u5458\u5BC6\u7801 <span class="token parameter variable">-S</span> server124.uit.devops.local

<span class="token comment"># \u91CD\u542F\u76F8\u5173\u670D\u52A1</span>
systemctl restart winbind
systemctl restart nmb
systemctl restart smb
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ul><li>\u8FD8\u539F\u4E4B\u524D\u4FEE\u6539\u7684\u914D\u7F6E\u6587\u4EF6</li><li>\u6E05\u7A7A\u7F13\u5B58</li><li><strong>etcd</strong> \u4E2D\u6E05\u7A7A\u8BB0\u5F55\u7684\u914D\u7F6E\u4FE1\u606F</li></ul></blockquote><h4 id="\u8865\u5145-\u9488\u5BF9-samba" tabindex="-1"><a class="header-anchor" href="#\u8865\u5145-\u9488\u5BF9-samba" aria-hidden="true">#</a> \u8865\u5145\uFF08<em>\u9488\u5BF9 Samba</em> \uFF09</h4><ol><li><p>\u5BF9\u4E8E\u7279\u6B8A\u7528\u6237\uFF0C\u63D0\u4F9B\u4E86\u5982\u4E0B\u7B80\u5355\u7684\u6620\u5C04\u673A\u5236</p><ul><li><p>\u5C06 Windows \u7BA1\u7406\u5458\uFF0C\u5982\uFF1Aadministrator \u6620\u5C04\u4E3A\u672C\u5730\u7528\u6237 root</p></li><li><p>\u5C06 everyone \u8FD9\u79CD\u7279\u6B8A\u7528\u6237 \u6620\u5C04\u4E3A nobody</p></li></ul></li><li><p>\u5BF9\u4E8E\u91CD\u540D\u9650\u5236\uFF0C\u754C\u9762\u4E0A\u5F00\u5173\u63A7\u5236\uFF0C\u5E76\u663E\u793A\u5168\u79F0</p><ul><li><p>\u91CD\u540D\uFF1A\u6307\u5B58\u5728 <code>\u3010ad\u57DF\u3011\u5F20\u4E09 &amp; \u3010\u672C\u5730\u3011\uFF1A\u5F20\u4E09</code> \u7684\u60C5\u51B5\uFF0C\u867D\u7136\u540D\u79F0\u76F8\u540C\uFF0C\u4F46 id \u53F7\u4E0D\u540C</p></li><li><p>\u6B64\u65F6\u8BBE\u7F6E\u8BBF\u95EE\u524D\uFF0C\u901A\u8FC7\u5F00\u5173\u63A7\u5236 \u4EC5\u672C\u5730 | \u6240\u6709\u7528\u6237\uFF0C\u82E5\u6240\u6709\uFF0C\u5219\u663E\u793A\u524D\u7F00</p></li></ul></li></ol><h2 id="_3-ldap3" tabindex="-1"><a class="header-anchor" href="#_3-ldap3" aria-hidden="true">#</a> 3. ldap3</h2>`,47),g=n("strong",null,"pip",-1),h={href:"https://ldap3.readthedocs.io/en/latest/welcome.html",target:"_blank",rel:"noopener noreferrer"},_=a(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ pip <span class="token function">install</span> ldap3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u7B80\u5355\u5EFA\u7ACB\u540C\u6B65\u8FDE\u63A5</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> ldap3 <span class="token keyword">import</span> Server<span class="token punctuation">,</span> Connection<span class="token punctuation">,</span> ALL

server <span class="token operator">=</span> Server<span class="token punctuation">(</span><span class="token string">&quot;uit.devops.local&quot;</span><span class="token punctuation">,</span> get_info<span class="token operator">=</span>ALL<span class="token punctuation">)</span>	<span class="token comment"># Windows \u642D\u5EFA\u7684AD Server \u57DF\u540D</span>
conn <span class="token operator">=</span> Connection<span class="token punctuation">(</span>server<span class="token punctuation">,</span> auto_bind<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span>

ret <span class="token operator">=</span> conn<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>standard<span class="token punctuation">.</span>who_am_i<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;who_am_i&quot;</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment"># who_am_i None</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>LDAP</strong> \u5141\u8BB8\u65E0\u9700\u8BA4\u8BC1\u7684\u533F\u540D\u767B\u5165\uFF0C\u56E0\u4E3A <strong>DAP</strong> \u534F\u8BAE\u6700\u65E9\u662F\u8BFB\u53D6\u7535\u8BDD\u7C3F\u7684\uFF0C\u4EFB\u4F55\u4EBA\u90FD\u53EF\u4EE5\u9605\u8BFB\uFF08<em>\u4F46\u5185\u5BB9\u4E0A\u4F1A\u90E8\u5206\u53D7\u9650</em>\uFF09\uFF0C\u4F46\u82E5\u5EFA\u7ACB\u8EAB\u4EFD\u8BA4\u8BC1\u7684\u4F1A\u8BDD\uFF0C\u5C31\u9700\u8981 <strong>DN</strong> \u548C <strong>\u5BC6\u7801</strong></p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> ldap3 <span class="token keyword">import</span> Server<span class="token punctuation">,</span> Connection<span class="token punctuation">,</span> ALL

server <span class="token operator">=</span> Server<span class="token punctuation">(</span><span class="token string">&quot;uit.devops.local&quot;</span><span class="token punctuation">,</span> get_info<span class="token operator">=</span>ALL<span class="token punctuation">)</span>
<span class="token comment"># conn = Connection(server, user=&quot;zhengze&quot;, password=&quot;user@dev&quot;, auto_bind=True) # \u6216\u4F7F\u7528 DN</span>
conn <span class="token operator">=</span> Connection<span class="token punctuation">(</span>server<span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token string">&#39;cn=zhengze,cn=Users,dc=uit,dc=devops,dc=local&#39;</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">&#39;user@dev&#39;</span><span class="token punctuation">,</span> auto_bind<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

ret <span class="token operator">=</span> conn<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>standard<span class="token punctuation">.</span>who_am_i<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>

<span class="token comment"># u:UIT\\zhengze</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-1-\u67E5\u8BE2" tabindex="-1"><a class="header-anchor" href="#_2-1-\u67E5\u8BE2" aria-hidden="true">#</a> 2.1 \u67E5\u8BE2</h3><p>\u53EF\u4F7F\u7528 <strong>\u4E0A\u4E0B\u6587\u7BA1\u7406\u5668</strong> \u81EA\u52A8\u7ED1\u5B9A\uFF0C\u67E5\u8BE2\u64CD\u4F5C\u5982\u4E0B</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">with</span> Connection<span class="token punctuation">(</span>server<span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token string">&#39;cn=zhengze,cn=Users,dc=uit,dc=devops,dc=local&#39;</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">&#39;user@dev&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>standard<span class="token punctuation">.</span>who_am_i<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">&#39;dc=uit,dc=devops,dc=local&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;(objectclass=user)&#39;</span><span class="token punctuation">,</span>
                attributes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;cn&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;mail&#39;</span><span class="token punctuation">,</span> <span class="token string">&quot;description&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;UserAccountControl&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>entries<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>entries<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>entry_to_json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>AD</strong> \u57DF &amp; <strong>LDAP</strong> \u67E5\u8BE2\u5668\uFF0C\u4F7F\u7528 <strong>search()</strong> \u67E5\u8BE2\uFF0C\u652F\u6301\u751F\u6210\u5668\u65B9\u5F0F\u5982\u4E0B</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> pprint

<span class="token comment"># \u6CE8\u91CA\u90E8\u5206\u4E3A AD \u57DF</span>
<span class="token keyword">def</span> <span class="token function">search_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># server = Server(host=&quot;172.16.70.124&quot;, port=389)</span>
    <span class="token comment"># with Connection(server, user=&quot;uit.devops.local\\\\administrator&quot;, password=&quot;xxxxxx&quot;, authentication=NTLM) as conn:</span>
    server <span class="token operator">=</span> Server<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">&quot;172.16.120.145&quot;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">389</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> Connection<span class="token punctuation">(</span>server<span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token string">&#39;cn=cloud,dc=uit,dc=ldevops,dc=local&#39;</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">&#39;xxxxxx&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
        conn<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;bound result&quot;</span><span class="token punctuation">,</span> conn<span class="token punctuation">.</span>bound<span class="token punctuation">)</span>
        entry_generator <span class="token operator">=</span> conn<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>standard<span class="token punctuation">.</span>paged_search<span class="token punctuation">(</span>
            <span class="token comment"># search_base=&quot;dc=uit,dc=devops,dc=local&quot;,</span>
            <span class="token comment"># attributes=[&#39;cn&#39;, &#39;name&#39;, &#39;mail&#39;, &quot;description&quot;, &quot;UserAccountControl&quot;, &quot;uid&quot;, &quot;sn&quot;, &quot;gidNumber&quot;],</span>
            search_base<span class="token operator">=</span><span class="token string">&quot;dc=uit,dc=ldevops,dc=local&quot;</span><span class="token punctuation">,</span>
            attributes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&#39;cn&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;mail&#39;</span><span class="token punctuation">,</span> <span class="token string">&quot;description&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;uid&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sn&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;gidNumber&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># &quot;UserAccountControl&quot;,</span>
            search_filter<span class="token operator">=</span><span class="token string">&#39;(objectclass=organizationalPerson)&#39;</span><span class="token punctuation">,</span>
            search_scope<span class="token operator">=</span>SUBTREE<span class="token punctuation">,</span>
            paged_size<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
            generator<span class="token operator">=</span><span class="token boolean">True</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">for</span> entry <span class="token keyword">in</span> entry_generator<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> entry<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;attributes&quot;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">yield</span> entry<span class="token punctuation">[</span><span class="token string">&#39;attributes&#39;</span><span class="token punctuation">]</span>


users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
entry <span class="token operator">=</span> search_generator<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> item <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        users<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>
        <span class="token keyword">break</span>

        
pprint<span class="token punctuation">.</span>pprint<span class="token punctuation">(</span>users<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,10);function y(f,w){const e=c("ExternalLinkIcon");return o(),l("div",null,[k,i(" more "),v,n("p",null,[n("a",m,[s("RedHat \u53C2\u8003"),t(e)])]),b,n("p",null,[g,s(" \u5B89\u88C5 "),n("a",h,[s("ldap3"),t(e)]),s(" \u5E93")]),_])}const D=p(d,[["render",y],["__file","Python\u5BF9\u63A5AD\u57DF.html.vue"]]);export{D as default};
