import{_ as o}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as p,c as i,e as c,a as n,b as e,d as s,f as t,r as l}from"./app.d500deb3.js";const u={},r=n("p",null,[n("strong",null,"Python"),s(" \u5F00\u6E90\u7684\u5F02\u6B65 "),n("strong",null,"etcd v3"),s(" \u5E93\uFF0C\u4F9D\u7136\u4E0D\u591F\u5B8C\u5584\u597D\u7528")],-1),d=n("h1",{id:"aioetcd3",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#aioetcd3","aria-hidden":"true"},"#"),s(" aioetcd3")],-1),k=s("\u5F02\u6B65 "),_=n("strong",null,"etcd v3",-1),v=s(" \u7248\u672C\u7684\u5E93\uFF0C\u501F\u52A9\u4E8E "),h={href:"https://github.com/hubo1016/aiogrpc",target:"_blank",rel:"noopener noreferrer"},m=s("aiogrpc"),b=s(" \u5F00\u6E90\u5E93\u5B9E\u73B0\uFF08"),g=n("em",null,"\u6A21\u62DF\u7684\u5F02\u6B65",-1),f=s("\uFF09\u56E0\u6B64\u5B58\u5728\u4E9B\u8BB8\u5C40\u9650"),y=s("\u5730\u5740: "),E={href:"https://github.com/gaopeiliang/aioetcd3",target:"_blank",rel:"noopener noreferrer"},w=s("github|aioetcd3"),T=s("\u5F15\u7528\u5E93 "),x={href:"https://github.com/hubo1016/aiogrpc",target:"_blank",rel:"noopener noreferrer"},D=s("aiogrpc"),N=s(" \u4F7F\u7528 "),q=n("code",null,"__anext__",-1),C=s("\u3001"),P=n("code",null,"loop.call_soon_threadsafe",-1),I=s(" \u3001"),F=n("code",null,"run_in_executor",-1),L=s(" \u7B49\u5B9E\u73B0"),O=n("li",null,[s("\u65B0\u7248\u672C\u5B98\u65B9\u5DF2\u63A8\u51FA\u5F02\u6B65 "),n("strong",null,"gRPC"),s(),n("a",{href:"/back_end/python/%E7%94%9F%E6%80%81/rpc/grpc"},"grpc.aio")],-1),U=t(`<h3 id="\u5B89\u88C5" tabindex="-1"><a class="header-anchor" href="#\u5B89\u88C5" aria-hidden="true">#</a> \u5B89\u88C5</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ pip <span class="token function">install</span> aioetcd3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_1-\u4F7F\u7528\u8BF4\u660E" tabindex="-1"><a class="header-anchor" href="#_1-\u4F7F\u7528\u8BF4\u660E" aria-hidden="true">#</a> 1. \u4F7F\u7528\u8BF4\u660E</h2><h4 id="_1-1-\u5F00\u6E90\u53C2\u8003" tabindex="-1"><a class="header-anchor" href="#_1-1-\u5F00\u6E90\u53C2\u8003" aria-hidden="true">#</a> 1.1 \u5F00\u6E90\u53C2\u8003</h4>`,4),j={href:"https://github.com/matrixji/eha/blob/master/eha/agent/server.py",target:"_blank",rel:"noopener noreferrer"},A=s("server"),S=t(`<h5 id="\u7F3A\u9677" tabindex="-1"><a class="header-anchor" href="#\u7F3A\u9677" aria-hidden="true">#</a> \u7F3A\u9677:</h5><p>\u5F53\u591A\u4E2A <code>endpoints</code> \u65F6\uFF0C\u5982\u4E0B\uFF1A</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;etcd_endpoints&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ipv4:///172.16.120.141:22379,172.16.120.142:22379,172.16.120.143:22379&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u82E5 <strong>172.16.120.141</strong> \u79BB\u7EBF\uFF0C\u8BE5\u5E93\u4F9D\u7136\u6709\u6982\u7387\u751F\u6210 <strong>141</strong> \u7684\u9519\u8BEF\u8FDE\u63A5\uFF0C\u5BFC\u81F4\u4E0D\u53EF\u7528</li><li>\u9700\u624B\u52A8\u6355\u83B7\u5F02\u5E38\u4E14 <code>update_server_list</code> \u5BB9\u9519\u5904\u7406</li></ul><h4 id="_1-2-\u7B80\u5355\u5C01\u88C5" tabindex="-1"><a class="header-anchor" href="#_1-2-\u7B80\u5355\u5C01\u88C5" aria-hidden="true">#</a> 1.2 \u7B80\u5355\u5C01\u88C5</h4><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path

<span class="token keyword">from</span> aioetcd3<span class="token punctuation">.</span>client <span class="token keyword">import</span> Client

<span class="token keyword">from</span> dashboard <span class="token keyword">import</span> settings
<span class="token keyword">from</span> rook<span class="token punctuation">.</span>parser <span class="token keyword">import</span> json_config

__all__ <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;EtcdProxy&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;get_db&quot;</span>
<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">load_endpoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># \u901A\u8FC7\u8BFBjson\u6587\u4EF6\u83B7\u53D6endpoints</span>
    endpoints <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">if</span> Path<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>ETCD_CONFIG<span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        conf <span class="token operator">=</span> json_config<span class="token punctuation">.</span>JsonConfig<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>ETCD_CONFIG<span class="token punctuation">)</span>
        endpoints <span class="token operator">=</span> conf<span class="token punctuation">.</span>get_key<span class="token punctuation">(</span><span class="token string">&quot;etcd_endpoints&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> endpoints


DEFAULT_ETCD_ENDPOINTS <span class="token operator">=</span> load_endpoints<span class="token punctuation">(</span><span class="token punctuation">)</span>
DEFAULT_ETCD_TIMEOUT <span class="token operator">=</span> <span class="token number">5</span>


<span class="token keyword">class</span> <span class="token class-name">EtcdProxy</span><span class="token punctuation">(</span>Client<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> endpoints<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span>DEFAULT_ETCD_TIMEOUT<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> endpoints<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>endpoints <span class="token operator">=</span> endpoints
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>endpoints <span class="token operator">=</span> DEFAULT_ETCD_ENDPOINTS
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">.</span>endpoints<span class="token punctuation">,</span> timeout<span class="token operator">=</span>timeout<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token string">&#39;_instance&#39;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            cls<span class="token punctuation">.</span>_instance <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">.</span>_instance

    <span class="token keyword">def</span> <span class="token function">reset_endpoints</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> endpoints<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;\u52A8\u6001\u8BBE\u7F6Eetcd\u5730\u5740  endpoints: &quot;ipv4://host:port
        &quot;&quot;&quot;</span>
        <span class="token keyword">global</span> DEFAULT_ETCD_ENDPOINTS
        <span class="token keyword">if</span> endpoints<span class="token punctuation">:</span>
            DEFAULT_ETCD_ENDPOINTS <span class="token operator">=</span> endpoints
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            DEFAULT_ETCD_ENDPOINTS <span class="token operator">=</span> load_endpoints<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> EtcdProxy<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u5206\u5E03\u5F0F\u9501" tabindex="-1"><a class="header-anchor" href="#_2-\u5206\u5E03\u5F0F\u9501" aria-hidden="true">#</a> 2. \u5206\u5E03\u5F0F\u9501</h3><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,8);function V(B,G){const a=l("ExternalLinkIcon");return p(),i("div",null,[r,c(" more "),d,n("p",null,[k,_,v,n("a",h,[m,e(a)]),b,g,f]),n("ul",null,[n("li",null,[y,n("a",E,[w,e(a)])]),n("li",null,[T,n("a",x,[D,e(a)]),N,q,C,P,I,F,L]),O]),U,n("p",null,[n("a",j,[A,e(a)])]),S])}const R=o(u,[["render",V],["__file","aioetcd3.html.vue"]]);export{R as default};
