---
title: kube-prometheus安装使用
date: 2022-10-24
category:
  - 运维
  - k8s
  - prometheus
tag:
  - prometheus
  - 监控
star: true
---

**k8s** 下 **prometheus** 的安装及使用



<!-- more -->

## 安装 kube-prometheus

[Github 地址](https://github.com/prometheus-operator/kube-prometheus)

```shell
git clone -b release-0.4 --single-branch https://github.com/prometheus-operator/kube-prometheus.git

cd ./kube-prometheus/manifests/setup

# 安装该目录下所有 yaml 文件
$ kubectl create -f .
customresourcedefinition.apiextensions.k8s.io/alertmanagers.monitoring.coreos.com created
... 
clusterrolebinding.rbac.authorization.k8s.io/prometheus-operator created
deployment.apps/prometheus-operator created
service/prometheus-operator created
serviceaccount/prometheus-operator created

# 查看运行
$ kubectl -n monitoring get po 
NAME                                   READY   STATUS    RESTARTS   AGE
prometheus-operator-5f75d76f9f-zkzf6   1/1     Running   0          1m20s

# 返回上级，继续创建
cd ..
$ kubectl create -f .

# 查看运行
$ kubectl -n monitoring get po -owide
NNAME                                   READY   STATUS              RESTARTS   AGE
alertmanager-main-0                    0/2     ContainerCreating   0          108s
grafana-58dc7468d7-wmp2p               0/1     Running             0          106s
kube-state-metrics-765c7c7f95-xn6kh    0/3     ContainerCreating   0          104s
node-exporter-99kq7                    0/2     ContainerCreating   0          104s
node-exporter-b9pfp                    2/2     Running             0          104s
node-exporter-qrdmv                    0/2     ContainerCreating   0          104s
prometheus-adapter-5cd5798d96-72fsl    1/1     Running             0          102s
prometheus-k8s-0                       0/3     ContainerCreating   0          98s
prometheus-k8s-1                       0/3     ContainerCreating   0          98s
prometheus-operator-5f75d76f9f-zkzf6   1/1     Running             0          18m
```

查看 **service** 如下服务应配置域名

```shell
$ kubectl -n monitoring get svc
NAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)
alertmanager-main       ClusterIP   10.96.65.3       <none>        9093/TCP
...
grafana                 ClusterIP   10.109.31.26     <none>        3000/TCP
...
prometheus-k8s          ClusterIP   10.105.151.175   <none>        9090/TCP
..
```

- **alertmanager-main** 用于查看当前告警有哪些、通知告警
-  **grafana** 监控面板、展示数据

- **prometheus-k8s** 创建规则、校验、查询等

```yaml
# 配置 ingress 如下
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: prom-ingresses
  namespace: monitoring
spec:
  rules:
  - host: alert.test.com
    http:
      paths:
      - backend:
          serviceName: alertmanager-main
          servicePort: 9093
        path: /
  - host: grafana.test.com
    http:
      paths:
      - backend:
          serviceName: grafana
          servicePort: 3000
        path: /
  - host: prom.test.com
    http:
      paths:
      - backend:
          serviceName: prometheus-k8s
          servicePort: 9090
        path: /
status:
  loadBalancer: {}
```

查看创建的 **ingress**

```shell
$ kubectl -n monitoring get ingress
NAME             HOSTS                                           ADDRESS   PORTS   AGE
prom-ingresses   alert.test.com,grafana.test.com,prom.test.com             80      78s
```

